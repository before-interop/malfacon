openapi: 3.0.3

info:
  title: Malfacon API
  version: 2.0.0
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html
  description: |
    Cet outil permet la déclaration et le traitement d'une malfaçon grâce à des flux normalisés.

    ## Dépendances

    Cette API est basé sur les APIs outils du [projet common](https://github.com/before-interop/common):

    * [TroubleTicket](https://before-interop.github.io/common/?urls.primaryName=TroubleTicket)
    * [Attachment](https://before-interop.github.io/common/?urls.primaryName=Attachment)
    * [Note](https://ggrebert.github.io/before-interop-common/?urls.primaryName=Note)
    * [Event](https://before-interop.github.io/common/?urls.primaryName=Event)

    ## Pagination

    Les listes de ressources sont paginées.

    * La valeur par défaut d'une page est `limit=50` et `offset=0`.
    * La valeur maximale de `limit` est `100`.
servers:
  - url: "{protocol}://{host}:{port}{basePath}"
    variables:
      protocol:
        enum:
          - https
          - http
        default: https
      host:
        default: localhost
      port:
        default: "8080"
      basePath:
        default: /api

tags:
  - name: TroubleTicket
    description: TroubleTicket management
  - name: Note
    description: Note management
  - name: Attachment
    description: Attachment management
  - name: Event
    description: Event management
  - name: OI
    description: OI endpoints
  - name: OC
    description: OC endpoints

paths:
  /malfacon:
    get:
      tags:
        - TroubleTicket
        - OI
      summary: Get all trouble tickets
      description: Get all trouble tickets
      operationId: getMalfacons
      parameters: &searchAndPaginateParameters
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/parameters/limit
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/parameters/offset
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/parameters/sort
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/fields.openapi.yaml#/components/parameters/fields
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The list of trouble tickets
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MalfaconBase"
        "400":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - TroubleTicket
        - OI
      summary: Count the number of trouble tickets
      description: Count the number of trouble tickets matching the given criteria.
      operationId: countMalfacons
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of trouble tickets.
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - TroubleTicket
        - OI
      summary: Create a trouble ticket
      description: Create a trouble ticket
      operationId: createMalfacon
      requestBody:
        description: The malfacon to create
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MalfaconBase"
      responses:
        "201": &troubleTicket201
          description: The created malfacon
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MalfaconBase"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/headers/ETag
        "400":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-400
        "403":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-403
          description: |
            **Forbidden**

            Le serveur a compris la requête, mais refuse de l'exécuter car le client n'a pas respecté le processus de création ou de mise à jour.

            Exemple: passage du status `ACKNOWLEDGED` à `RESOLVED` sans passer par le status `IN_PROGRESS`.

            * Le champ `reason` de la réponse d'erreur doit contenir la liste des tickets en conflit séparés par des virgules.
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

  /malfacon/{malfaconId}:
    parameters:
      - $ref: "#/components/parameters/malfaconId"

    get:
      tags:
        - TroubleTicket
        - OI
      summary: Get a trouble ticket
      description: Get a trouble ticket
      operationId: getMalfacon
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/fields.openapi.yaml#/components/parameters/fields
      responses:
        "200":
          description: The malfacon
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MalfaconBase"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/headers/ETag
        "404":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    put:
      tags:
        - TroubleTicket
        - OI
      summary: Update a trouble ticket
      description: Update a trouble ticket
      operationId: updateMalfacon
      requestBody:
        description: The trouble ticket to update
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MalfaconBase"
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/parameters/If-Match
      responses:
        "200": *troubleTicket201
        "400":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-400
        "403":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-403
        "404":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-404
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-412
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    patch:
      tags:
        - TroubleTicket
        - OI
      summary: Partially update a trouble ticket
      description: Partially update a trouble ticket
      operationId: patchMalfacon
      requestBody:
        description: The data to update
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MalfaconBase"
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/parameters/If-Match
      responses:
        "200": *troubleTicket201
        "400":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-400
        "403":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-403
        "404":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-404
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-412
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

  /malfacon/{malfaconId}/note:
    parameters:
      - $ref: "#/components/parameters/malfaconId"

    get:
      tags:
        - Note
        - OI
      summary: Get all notes of a trouble ticket
      description: Get all notes of a trouble ticket
      operationId: getMalfaconNotes
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of notes
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Note"
        "400":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-400
        "404":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Note
        - OI
      summary: Count the number of notes of a trouble ticket
      description: Count the number of notes of a trouble ticket matching the given criteria.
      operationId: countMalfaconNotes
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of notes
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-400
        "404":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Note
        - OI
      summary: Create a note for a trouble ticket
      description: Create a note for a trouble ticket
      operationId: createMalfaconNote
      requestBody:
        description: The note to create
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Note"
      responses:
        "201":
          description: The created note
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Note"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/headers/ETag
        "400":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-400
        "404":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

  /malfacon/{malfaconId}/attachment:
    parameters:
      - $ref: "#/components/parameters/malfaconId"

    get:
      tags:
        - Attachment
        - OI
      summary: List attachments
      description: Get all attachments of a trouble ticket
      operationId: getMalfaconAttachments
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of attachments
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AttachmentMalfacon"
        "400":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-400
        "404":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Attachment
        - OI
      summary: Get the number of attachments
      description: This method returns the number of attachments matching the criteria.
      operationId: countMalfaconAttachments
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of attachments
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-400
        "404":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Attachment
        - OI
      summary: Create a attachment
      description: This method allows to create a attachment.
      operationId: createMalfaconAttachment
      requestBody:
        description: The attachment to create
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: "#/components/schemas/AttachmentMalfacon"
              required:
                - size
                - sha256
      responses:
        "200":
          description: |
            The attachment multipart metadata.
            You have to use the generated `id` to upload the content of the attachment with the `POST /attachment/{id}/content/{chunkIndex}` method,
            and finalize the creation of the attachment with the `POST /attachment/{id}/finalize` method.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/AttachmentMalfaconMultiPart"
          headers:
            ETag:
              $ref: "https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/headers/ETag"
            X-Chunk-Size:
              description: The size max in octet allowed for a chunk
              schema:
                type: integer
        "400":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-400
        "404":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

  /malfacon/{malfaconId}/attachment/{attachmentId}/content:
    parameters:
      - $ref: "#/components/parameters/malfaconId"
      - $ref: "#/components/parameters/attachmentId"

    get:
      tags:
        - Attachment
        - OI
      summary: Download the content of an attachment
      description: This method allows to download the content of an attachment.
      operationId: downloadMalfaconAttachment
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Match
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/If-None-Match
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Modified-Since
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Unmodified-Since
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/Range
      responses:
        "200":
          description: The content of the attachment
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "404":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-412

  /malfacon/{malfaconId}/attachment/{attachmentId}/content/{chunkIndex}:
    parameters:
      - $ref: "#/components/parameters/malfaconId"
      - $ref: "#/components/parameters/attachmentId"
      - $ref: "#/components/parameters/chunkIndex"
    post:
      tags:
        - Attachment
        - OI
      summary: upload a specific chunk of the content of an attachment
      description:
        "This method allows to upload a specific chunk of the content of an attachment identified by its id (attachmentId) \
        for a specific ticket identified by its id (malfaconId)."
      operationId: uploadMalfaconAttachmentContentChunk
      requestBody:
        description: A chunk of the content of the attachment
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: The chunk of the content of the attachment
                metadata:
                  $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Attachment.openapi.yaml#/components/schemas/Chunk
              required:
                - file
                - metadata
      responses:
        "200":
          description: The chunk has been uploaded (the property uploadChunks has been updated with the new chunk index)
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AttachmentMalfaconMultiPart"
        "404":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-404
        "413":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-413
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

  /malfacon/{malfaconId}/attachment/{attachmentId}/finalize:
    parameters:
      - $ref: "#/components/parameters/malfaconId"
      - $ref: "#/components/parameters/attachmentId"
    post:
      tags:
        - Attachment
        - OI
      summary: Finalize the creation of the content of an attachment
      description: |
        This method allows to finalize the creation of the content of an attachment.
        The server will aggregate all the chunks uploaded and validate the content of the attachment
        in an asynchronous way.
        The status of the attachment should be set to UPLOADED.
      operationId: finalizeMalfaconAttachmentCreation
      requestBody:
        description: finalize the content of the attachment. No body is required
        content:
          application/json:
            schema:
              type: object
              nullable: true
      responses:
        "200":
          description: All the chunks have been uploaded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AttachmentMalfaconMultiPart"
        "404":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

  /malfacon/event:
    get:
      tags:
        - Event
        - OI
      summary: Get all events of all trouble tickets
      description: Get all events of all trouble tickets
      operationId: getMalfaconEvents
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of events
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Event"
        "400":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Event
        - OI
      summary: Count the number of events of all trouble tickets
      description: Count the number of events of all trouble tickets matching the given criteria.
      operationId: countMalfaconEvents
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of events
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Event
        - OC
      summary: Receive an event for a trouble ticket
      description: Receive an event for a trouble ticket
      operationId: receiveMalfaconEvent
      requestBody:
        description: The event to receive
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Event"
      responses:
        "200":
          description: The event has been received
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        "204":
          description: The event has been received

        default:
          description: |
            L'événement a été reçu avec succès.

            La réponse n'a pas l'obligation de contenir un body.
            Si l'OC retourne un body, celui-ci pourra être enregistré dans le journal de l'OI.
        "400":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-400
        "403":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-403
        "404":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-404
        "500":
          description: |
            **Internal Server Error**

            Cette erreur se produit lorsque le serveur a rencontré une condition inattendue qui l'a empêché de répondre à la demande.

            * Le champ reason de la réponse d'erreur peut contenir des informations sur l'erreur.
          content:
            application/json:
              schema:
                $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-500
        "501":
          description: |
            **Not Implemented**

            Cette erreur se produit lorsque le serveur ne prend pas en charge la fonctionnalité nécessaire pour répondre à la demande

            * Le champ reason de la réponse d'erreur peut contenir des informations sur l'erreur.

components:
  schemas:
    MalfaconBase:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/TroubleTicket.openapi.yaml#/components/schemas/TroubleTicket
        - discriminator:
            propertyName: "@type"
            mapping:
              "malfacon.pm.oi": "#/components/schemas/MalfaconOiPm"
              "malfacon.amontpm.oi": "#/components/schemas/MalfaconOiAmontPm"
              "malfacon.pbo.oi": "#/components/schemas/MalfaconOiPbo"
              "malfacon.ccf.oi": "#/components/schemas/MalfaconOiCcf"
              "malfacon.pm.oc": "#/components/schemas/MalfaconOcPm"
              "malfacon.amontpm.oc": "#/components/schemas/MalfaconOcAmontPm"
              "malfacon.pmpbo.oc": "#/components/schemas/MalfaconOcPmPbo"
              "malfacon.pbo.oc": "#/components/schemas/MalfaconOcPbo"
              "malfacon.ccf.oc": "#/components/schemas/MalfaconOcCcf"
          type: object
          required:
            - code_oi
            - code_oc
            - "@type"
            - severity
            - quantity
            - name
          properties:
            code_oi: #Code ARCEP de l'OI.
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/CodeOperateurArcep
            code_oc: #Code ARCEP de l'OC.
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/CodeOperateurArcep
            externalId:
              description: Référence du ticket créé dans le système de l'OC
              type: string
            quantity:
              description: |
                The volumetry of the malfacon.
              type: integer
              example: 1
            recoveryQuantity:
              description: |
                Ce champs indique la quantité de malfaçon reprise.
                C'est un entier qui doit être renseignée au moment du passage en Resolved, par l'OC ou par l'OI suivant le cas de gestion,
                et donc la valeur doit être >= au champs quantity renseigné à l'initialisation du ticket.
              type: integer
            name:
              type: string
              readOnly: true
            "@type":
              type: string
              readOnly: false
            "@baseType":
              default: "Malfacon"
              type: string
            severity:
              type: string
              description: |
                The severity of the malfacon

                Allowed values are:

                * `CRITICAL`

                  Si la malfaçon représente un danger grave est imminent pour les personnes,
                  l'OI se réserve le droit d'effectuer la reprise ou à minima sécurise les lieux
                  et demande à l'OC d'intervenir.

                  De son côté, l'OC se doit de signaler à l'OI toute malfaçon
                  représentant un danger grave et imminent pour les personnes.

                * `MAJOR`

                  La malfaçon signifie une détérioration du site technique ou un risque d'intéruption
                  massive de service (dérangement collectif) ou un empêchement à produire
                  de nouveaux client (depuis le passage de commande jusqu'au raccordement).

                  Exemples:

                  * défaut d'étanchéité sur PB
                  * PM ouvert
                  * site insalubre
                  * brassage encombrant
                  * données de localisation erronées

                * `MINOR`

                  Les autres non conformités à corriger.
              enum:
                - CRITICAL
                - MAJOR
                - MINOR
            status:
              type: string
              description: |
                Status de la malfacon.

                ![Malfacon status diagram](./statusOiOcImput.drawio.svg)
              enum:
                - ACKNOWLEDGED
                - CANCELED
                - CLOSED
                - CREATING
                - IN_PROGRESS
                - PENDING
                - REJECTED
                - RESOLVED
              default: CREATING
            acknowledgedDate:
              type: string
              format: date
              description: Date de passage au status ACKNOWLEDGED.
            ladtModificationBy:
              required: true
              description: Identifiant du dernier auteur ayant mis à jour la malfaçon.
              type: string
              enum:
                - OI
                - OC

    MalfaconOcBase:
      allOf:
        - $ref: "#/components/schemas/MalfaconBase"
        - required:
            - statusChangeReason
          properties:
            statusChangeReason:
              type: string
              enum:
                - ACKNOWLEDGED
                - CLOSED
                - CREATING
              default: CREATING

    MalfaconOiBase:
      allOf:
        - $ref: "#/components/schemas/MalfaconBase"
        - required:
            - attributable
            - ocNumber
            - resolutionOwner
            - statusChangeReason
          properties:
            attributable:
              type: boolean
            ocNumber:
              description: |
                Nombre d'OCs concernés par la malfaçon.
                OcNumber doit être supérieur ou égal à 1 et obligatoire
              type: integer
              readOnly: true
              minimum: 1
            activationRate:
              description: Le taux d'activation est un pourcentage représentant la part de lignes activées par l'OC sur l'élément de réseau (PM ou PBO).
              type: number
              minimum: 0
              exclusiveMinimum: true
              maximum: 100
              readOnly: true
            resolutionOwner:
              type: string
              readOnly: true
              enum:
                - OI
                - OC
              default: OC
            statusChangeReason:
              type: string
              enum:
                - ACKNOWLEDGED
                - ATTRIBUTABLE_ACCEPTED
                - CANCELED
                - CONTESTATION_ACCEPTED
                - CONTESTATION_DUPLICATE
                - CONTESTATION_EQUIPMENT_ERROR
                - CONTESTATION_NOT_ALLOWED
                - CONTESTATION_OC_ERROR
                - CONTESTATION_OI_RESPONSABILITY
                - CONTESTATION_ORDER_PUT_INTO_SERVICE_FOR_MORE_THAN_A_YEAR
                - CONTESTATION_PHOTO_NOT_USABLE
                - CONTESTATION_REFUSED
                - CREATING
                - CRITICAL
                - INFORMATION_GIVEN
                - INFORMATION_REQUEST
                - INVALID_FORMAT
                - NON_ATTRIBUTABLE
                - OC_RESOLUTION_DELAY_EXPIRED
                - OI_RESOLUTION_IMPOSSIBLE
                - OI_RESOLUTION_RENUNCIATION
                - OI_RESPONSE_DELAY_EXPIRED
                - OI_VALIDATION_DELAY_EXPIRED
                - RESOLUTION_REFUSED_EQUIPMENT_ERROR
                - RESOLUTION_REFUSED_NOT_REPAIRED
                - RESOLUTION_REFUSED_PARTIALLY_RESOLVED
                - RESOLUTION_REFUSED_PHOTO_NOT_USABLE
                - RESOLVED_OC
                - RESOLVED_OC_VALIDATED
                - RESOLVED_OI_ATTRIBUTABLE
                - RESOLVED_OI_CRITICAL
                - RESOLVED_OI_NON_ATTRIBUTABLE
                - RESOLVED_OI_VALIDATED
              default: CREATING
            maxResolutionOcDuration:
              $ref: "#/components/schemas/MaxResolutionOcDuration"
            totalResolutionOcDuration:
              description: The OC resolution duration in seconds. Calculated only as long as ResolutionOwner = OC
              type: number
            expectedResolutionDate:
              description: The maximum OC resolution date, recalculated only during state changes taking into account the ticket creation date and successive pauses.
              type: string
              format: date
            validationDueDate:
              description: The deadline for validation status
              type: string
              format: date
            pendingDueDate:
              description: The deadline for pending status
              type: string
              format: date

    MaxResolutionOcDuration:
      type: object
      properties:
        value:
          type: integer
          description: Duration in seconds
          readOnly: true
        reason:
          type: string
          readOnly: true

    MalfaconOiPm:
      allOf:
        - $ref: "#/components/schemas/MalfaconOiBase"
        - required:
            - pm
            - codeFault
            - localizationDetails
          properties:
            localization:
              type: string
              default: "PM"
            localizationDetails:
              type: string
              description: |
                Détails de localisation de la malfacon

                Liste des valeurs possibles:

                | Code | valeur                                                                                 |
                | ---- | -------------------------------------------------------------------------------------- |
                | LD02 | ARMOIRE                                                                                |
                | LD04 | BRASSAGE_OC                                                                            |
                | LD09 | CONNECTEUR_TIROIR_ZAPM                                                                 |
                | LD15 | ROUTE_OPTIQUE                                                                          |
                | LD16 | TIROIR_OC                                                                              |
                | LD17 | TIROIR_ZAPM                                                                            |

              enum:
                - LD02
                - LD04
                - LD09
                - LD15
                - LD16
                - LD17
            codeFault:
              type: string
              description: |
                Code du défaut de la malfacon.

                Liste des valeurs possibles:

                | Code | valeur                                                                                 |
                | ---- | -------------------------------------------------------------------------------------- |
                | FD06 | bouchon absent                                                                         |
                | FD09 | cheminement non conforme aux STAS…                                         |
                | FD12 | cheminement non conforme surplomb domaine privé, …                                     |
                | FD14 | cordon non conforme aux STAS caractéristiques techniques                               |
                | FD17 | dégradation majeure                                                                    |
                | FD18 | dégradation porte                                                                      |
                | FD19 | dégradation serrure                                                                    |
                | FD20 | dégradation tambours                                                                   |
                | FD21 | dégradation tiroirs cassés                                                             |
                | FD22 | environnement nettoyage déchets, fermeture                                             |
                | FD26 | implantation ou étiquetage non conforme aux STAS                                       |
                | FD31 | mauvaise fixation                                                                      |
                | FD32 | mauvaise fixation ou fermeture dégradée                                                |
                | FD36 | non respect Route Optique communiquée                                                  |
                | FD41 | présence de cordons à zéro non retirés                                                 |
                | FD50 | dégradation autres                                                                     |
              enum:
                - FD06
                - FD09
                - FD12
                - FD14
                - FD17
                - FD18
                - FD19
                - FD20
                - FD21
                - FD22
                - FD26
                - FD31
                - FD32
                - FD36
                - FD41
                - FD50
            pm:
              $ref: "#/components/schemas/PM"
            opticalRoute:
              type: array
              items:
                $ref: "#/components/schemas/MalfaconOpticalRoutePM"

    MalfaconOiAmontPm:
      allOf:
        - $ref: "#/components/schemas/MalfaconOiBase"
        - required:
            - pm
            - codeFault
            - localizationDetails
          properties:
            localization:
              type: string
              default: "AMONT_PM"
            localizationDetails:
              type: string
              description: |
                Détails de localisation de la malfacon

                Liste des valeurs possibles:

                | Code | valeur                                                                                 |
                | ---- | -------------------------------------------------------------------------------------- |
                | LD08 | COLLECTE_LIEN_PM_PRDM                                                                  |
                | LD18 | ADDUCTION_OC                                                                           |

              enum:
                - LD08
                - LD18
            codeFault:
              type: string
              description: |
                Code du défaut de la malfacon.

                Liste des valeurs possibles:

                | Code | valeur                                                                                 |
                | ---- | -------------------------------------------------------------------------------------- |
                | FD06 | bouchon absent                                                                         |
                | FD08 | brassage OC non conforme                                                               |
                | FD11 | cheminement câble OC/OI non conforme                                                   |
                | FD27 | implantation tiroir OC/OI ou étiquetage non conforme                                   |

              enum:
                - FD06
                - FD08
                - FD11
                - FD27
            pm:
              $ref: "#/components/schemas/PM"

    MalfaconOiPbo:
      allOf:
        - $ref: "#/components/schemas/MalfaconOiBase"
        - required:
            - pbo
            - codeFault
            - localizationDetails
          properties:
            localization:
              type: string
              default: "PBO"
            localizationDetails:
              type: string
              description: |
                Détails de localisation de la malfacon

                Liste des valeurs possibles:

                | Code | valeur                                                                                 |
                | ---- | -------------------------------------------------------------------------------------- |
                | LD03 | BOITIER                                                                                |
                | LD07 | CASSETTE                                                                               |
                | LD11 | PBO_ENVIRONNEMENT                                                                      |
                | LD15 | ROUTE_OPTIQUE                                                                          |
              enum:
                - LD03
                - LD07
                - LD11
                - LD15
            codeFault:
              type: string
              description: |
                Code du défaut de la malfacon.

                Liste des valeurs possibles:

                | Code | valeur                                                                                 |
                | ---- | -------------------------------------------------------------------------------------- |
                | FD05 | boîtier PBO non/mal refermé, non/mal refixé,…                                          |
                | FD15 | dégradation                                                                            |
                | FD16 | dégradation du support PBO poteau                                                      |
                | FD23 | épissure non conforme dénudage, protection de soudure                                  |
                | FD29 | lovage fibre non conforme aux STAS                                                     |
                | FD30 | lovage câble en chambre ou poteau non conforme aux STAS                                |
                | FD34 | nettoyage chantier                                                                     |
                | FD36 | non respect Route Optique communiquée                                                  |
                | FD44 | raccordement de site non déployé dans IPE                                              |
                | FD46 | reprise sauvage Route Optique par casse soudure au PBO                                 |
                | FD47 | taille SMOOVE non conforme                                                             |
              enum:
                - FD05
                - FD15
                - FD16
                - FD23
                - FD29
                - FD30
                - FD34
                - FD36
                - FD44
                - FD46
                - FD47
            pbo:
              $ref: "#/components/schemas/PBO"
            pm:
              $ref: "#/components/schemas/PM"
            opticalRoute:
              type: array
              items:
                $ref: "#/components/schemas/MalfaconOpticalRoutePBO"
            referencePrestationPrise:
              description: Référence Prestation Prise
              type: string
    MalfaconOiCcf:
      allOf:
        - $ref: "#/components/schemas/MalfaconOiBase"
        - required:
            - codeFault
            - localizationDetails
            - refPrestationPrise
          properties:
            localization:
              type: string
              default: "CCF"
            localizationDetails:
              type: string
              description: |
                Détails de localisation de la malfacon

                Liste des valeurs possibles:

                | Code | valeur                                                                                 |
                | ---- | -------------------------------------------------------------------------------------- |
                | LD05 | CABLE_CARACTERISTIQUE                                                                  |
                | LD06 | CABLE_INSTALLATION                                                                     |
                | LD10 | ENTREE_DE_CABLE_PBO                                                                    |
                | LD13 | PTO_CARACTERISTIQUE                                                                    |
                | LD14 | PTO_INSTALLATION                                                                       |
              enum:
                - LD05
                - LD06
                - LD10
                - LD13
                - LD14
            codeFault:
              type: string
              description: |
                Code du défaut de la malfacon.

                Liste des valeurs possibles:

                | Code | valeur                                                                                 |
                | ---- | -------------------------------------------------------------------------------------- |
                | FD02 | absence protection obligatoire gaine fendue, demi-lune, …                              |
                | FD10 | caractéristiques non conformes aux STAS                                                |
                | FD13 | cheminement non conforme surplomb domaine privé, …                                     |
                | FD15 | dégradation                                                                            |
                | FD25 | étiquetage non conforme aux STAS                                                       |
                | FD33 | modularité du câble CCF non conforme                                                   |
                | FD34 | nettoyage chantier                                                                     |
                | FD40 | pose non conforme implantation ou fixation                                             |
                | FD43 | PTO mal ou non étiquetée                                                               |
                | FD45 | rebouchage non effectué                                                                |
                | FD49 | type de pose/fixation non conforme aux préconisations OI                               |
                | FD51 | entrée cable pbo non conforme aux STAS                                                 |
              enum:
                - FD02
                - FD10
                - FD13
                - FD15
                - FD25
                - FD33
                - FD34
                - FD40
                - FD43
                - FD45
                - FD49
                - FD51
            refPrestationPrise:
              description: Référence de la commande
              type: string
            geographicLocation: # Localisation GPS du câble
              $ref: "#/components/schemas/GeographicLocation"
            pbo:
              $ref: "#/components/schemas/PBO"
            pto:
              $ref: "#/components/schemas/PTO"

    MalfaconOcPm:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
        - required:
            - pm
            - codeFault
            - localizationDetails
          properties:
            localization:
              type: string
              default: "PM"
            localizationDetails:
              type: string
              description: |
                Détails de localisation de la malfacon

                Liste des valeurs possibles:

                | Code | valeur                                                                                 |
                | ---- | -------------------------------------------------------------------------------------- |
                | LD02 | ARMOIRE                                                                                |
                | LD04 | BRASSAGE_OC                                                                            |
                | LD09 | CONNECTEUR_TIROIR_ZAPM                                                                 |
                | LD17 | TIROIR_ZAPM                                                                            |
              enum:
                - LD02
                - LD04
                - LD09
                - LD17
            codeFault:
              type: string
              description: |
                Code du défaut de la malfacon.

                Liste des valeurs possibles:

                | Code | valeur                                                                                 |
                | ---- | -------------------------------------------------------------------------------------- |
                | FD06 | bouchon absent                                                                         |
                | FD07 | brassage existant encombrant le cheminement                                            |
                | FD18 | dégradation porte                                                                      |
                | FD19 | dégradation serrure                                                                    |
                | FD20 | dégradation tambours                                                                   |
                | FD21 | dégradation tiroirs cassés                                                             |
                | FD22 | environnement nettoyage déchets, fermeture                                             |
                | FD24 | étiquetage du PM non conforme hors échec de production                                 |
                | FD32 | mauvaise fixation ou fermeture dégradée                                                |
                | FD42 | présence de cordons non conformes                                                      |
                | FD50 | dégradation autres                                                                     |
              enum:
                - FD06
                - FD07
                - FD18
                - FD19
                - FD20
                - FD21
                - FD22
                - FD24
                - FD32
                - FD42
                - FD50
            pm:
              $ref: "#/components/schemas/PM"

    MalfaconOcAmontPm:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
        - required:
            - pm
            - codeFault
            - localizationDetails
          properties:
            localization:
              type: string
              default: "AMONT_PM"
            localizationDetails:
              type: string
              description: |
                Détails de localisation de la malfacon

                Liste des valeurs possibles:

                | Code | valeur                                                                                 |
                | ---- | -------------------------------------------------------------------------------------- |
                | LD01 | AMONT_PM_INSTALLATION                                                                  |
                | LD08 | COLLECTE_LIEN_PM_PRDM                                                                  |
                | LD18 | ADDUCTION_OC                                                                           |

              enum:
                - LD01
                - LD08
                - LD18
            codeFault:
              type: string
              description: |
                Code du défaut de la malfacon.

                Liste des valeurs possibles:

                | Code | valeur                                                                                 |
                | ---- | -------------------------------------------------------------------------------------- |
                | FD06 | bouchon absent                                                                         |
                | FD11 | cheminement câble OC/OI non conforme                                                   |
                | FD27 | implantation tiroir OC/OI ou étiquetage non conforme                                   |
                | FD39 | passage de câble non conforme                                                          |
                | FD48 | tiroir OI dégradé                                                                      |

              enum:
                - FD06
                - FD11
                - FD27
                - FD39
                - FD48
            pm:
              $ref: "#/components/schemas/PM"

    MalfaconOcPmPbo:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
        - required:
            - pm
            - pbo
            - codeFault
            - localizationDetails
          properties:
            localization:
              type: string
              default: "PM_PBO"
            localizationDetails:
              type: string
              description: |
                Détails de localisation de la malfacon

                Liste des valeurs possibles:

                | Code | valeur                                                                                 |
                | ---- | -------------------------------------------------------------------------------------- |
                | LD12 | PM_PBO_INSTALLATION                                                                    |

              enum:
                - LD12
            codeFault:
              type: string
              description: |
                Code du défaut de la malfacon.

                Liste des valeurs possibles:

                | Code | valeur                                                                                 |
                | ---- | -------------------------------------------------------------------------------------- |
                | FD01 | absence de gaine demi-lune pour protéger câble PBO aérien, poteau ou façade            |
                | FD15 | dégradation                                                                            |

              enum:
                - FD01
                - FD15
            pm:
              $ref: "#/components/schemas/PM"
            pbo:
              $ref: "#/components/schemas/PBO"

    MalfaconOcPbo:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
        - required:
            - codeFault
            - localizationDetails
          properties:
            localization:
              type: string
              default: "PBO"
            localizationDetails:
              type: string
              description: |
                Détails de localisation de la malfacon

                Liste des valeurs possibles:

                | Code | valeur                                                                                 |
                | ---- | -------------------------------------------------------------------------------------- |
                | LD03 | BOITIER                                                                                |
                | LD07 | CASSETTE                                                                               |
                | LD11 | PBO_ENVIRONNEMENT                                                                      |

              enum:
                - LD03
                - LD07
                - LD11
            codeFault:
              type: string
              description: |
                Code du défaut de la malfacon.

                Liste des valeurs possibles:

                | Code | valeur                                                                                 |
                | ---- | -------------------------------------------------------------------------------------- |
                | FD04 | boîtier PBO non/mal étiqueté hors échec production                                     |
                | FD15 | dégradation                                                                            |
                | FD16 | dégradation du support PBO poteau                                                      |
                | FD28 | localisation non conforme aux données OI commande accès hors échec production          |
                | FD29 | lovage fibre non conforme aux STAS                                                     |
                | FD30 | lovage câble en chambre ou poteau non conforme aux STAS                                |

              enum:
                - FD04
                - FD15
                - FD16
                - FD28
                - FD29
                - FD30
            pbo:
              $ref: "#/components/schemas/PBO"
            pm:
              $ref: "#/components/schemas/PM"

    MalfaconOcCcf:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
        - required:
            - pbo
            - pto
            - codeFault
            - localizationDetails
          properties:
            localization:
              type: string
              default: "CCF"
            localizationDetails:
              type: string
              description: |
                Détails de localisation de la malfacon

                Liste des valeurs possibles:

                | Code | valeur                                                                                 |
                | ---- | -------------------------------------------------------------------------------------- |
                | LD06 | CABLE_INSTALLATION                                                                     |

              enum:
                - LD06
            codeFault:
              type: string
              description: |
                Code du défaut de la malfacon.

                Liste des valeurs possibles:

                | Code | valeur                                                                                 |
                | ---- | -------------------------------------------------------------------------------------- |
                | FD02 | absence protection obligatoire gaine fendue, demi-lune, …                              |
                | FD03 | bilan optique non conforme aux STAS                                                    |
                | FD13 | cheminement non conforme surplomb domaine privé, …                                     |
                | FD37 | non utilisable pas d'autorisation de cheminement                                       |
                | FD38 | non utilisable risque de surplomb, sécurisé                                            |

              enum:
                - FD02
                - FD03
                - FD13
                - FD37
                - FD38
            refOrder:
              description: Référence de la commande
              type: string
            geographicLocation: # Localisation GPS du câble
              $ref: "#/components/schemas/GeographicLocation"
            pbo:
              $ref: "#/components/schemas/PBO"
            pto:
              $ref: "#/components/schemas/PTO"

    GeographicLocation:
      $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/GeographicPoint

    Note:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Note.openapi.yaml#/components/schemas/Note
        - properties:
            relatedEntity:
              description: |
                Relation entre la note et la malfaçon.
                Ce champ est renseigné par l'OI lors de la création de la note.
              type: array
              minItems: 1
              maxItems: 1
              readOnly: true
              items:
                allOf:
                  - $ref: "#/components/schemas/RelatedMalfacon"

    MalfaconMimeType:
      properties:
        mimeType:
          type: string
          enum:
            - application/pdf
            - application/vnd.oasis.opendocument.spreadsheet
            - application/vnd.oasis.opendocument.text
            - application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
            - application/vnd.openxmlformats-officedocument.wordprocessingml.document
            - text/csv
            - image/jpeg
            - image/jpg
            - image/png
            - image/svg+xml

    AttachmentMalfaconPreuve:
      properties:
        proofType:
          type: string
          enum:
            - ISSUE
            - RESOLUTION
          default: ISSUE
        primary:
          type: boolean
          description: Specify if this is the main attachment. There can only be one primary attachment for each type.
          default: true
      description: |
        To solve the malfacon, a photo has to be sent and acts as proof.

    MalfaconRelatedEntity:
      properties:
        relatedEntity:
          type: array
          description: Reference to the malfacon
          minItems: 1
          maxItems: 1
          readOnly: true
          items:
            allOf:
              - $ref: "#/components/schemas/RelatedMalfacon"

    AttachmentMalfacon:
      allOf:
        - $ref: "https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Attachment.openapi.yaml#/components/schemas/AttachmentBase"
        - $ref: "#/components/schemas/MalfaconRelatedEntity"
      discriminator:
        propertyName: "@type"
        mapping:
          "documentMonoPartStandard": "#/components/schemas/AttachmentMalfaconMonoPartStandard"
          "documentMultiPartStandard": "#/components/schemas/AttachmentMalfaconMultiPartStandard"
          "documentMonoPart": "#/components/schemas/AttachmentMalfaconMonoPart"
          "documentMultiPart": "#/components/schemas/AttachmentMalfaconMultiPart"

    AttachmentMalfaconMonoPart:
      allOf:
        - $ref: "#/components/schemas/AttachmentMalfacon"
        - $ref: "https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Attachment.openapi.yaml#/components/schemas/AttachmentMonoPart"
      properties:
        "@type":
          type: string
          default: "documentMonoPart"
      required:
        - "@type"

    AttachmentMalfaconMultiPart:
      allOf:
        - $ref: "#/components/schemas/AttachmentMalfacon"
        - $ref: "https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Attachment.openapi.yaml#/components/schemas/AttachmentMultiPart"
      properties:
        "@type":
          type: string
          default: "documentMultiPart"
      required:
        - "@type"

    AttachmentMalfaconMonoPartStandard:
      allOf:
        - $ref: "#/components/schemas/AttachmentMalfaconMonoPart"
        - $ref: "#/components/schemas/MalfaconMimeType"
        - $ref: "#/components/schemas/AttachmentMalfaconPreuve"
      properties:
        "@type":
          type: string
          default: "documentMonoPartStandard"
      required:
        - "@type"

    AttachmentMalfaconMultiPartStandard:
      allOf:
        - $ref: "#/components/schemas/AttachmentMalfaconMultiPart"
        - $ref: "#/components/schemas/MalfaconMimeType"
        - $ref: "#/components/schemas/AttachmentMalfaconPreuve"
      properties:
        "@type":
          type: string
          default: "documentMultiPartStandard"
      required:
        - "@type"

    Event:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/CloudEvent.openapi.yaml#/components/schemas/CloudEvent
        - required:
            - time
            - subject
            - type
          discriminator:
            propertyName: type
            mapping:
              "fr.interop.malfacon.create": "#/components/schemas/EventMalfaconCreate"
              "fr.interop.malfacon.update": "#/components/schemas/EventMalfaconUpdate"
              "fr.interop.malfacon.note.create": "#/components/schemas/EventMalfaconNote"
              "fr.interop.malfacon.attachment.create": "#/components/schemas/EventMalfaconAttachmentCreate"
              "fr.interop.malfacon.attachment.update": "#/components/schemas/EventMalfaconAttachmentUpdate"
          properties:
            subject:
              description: Identifiant unique de la malfaçon.
              type: string
              format: uuid
            type:
              type: string
            datacontenttype:
              type: string
              default: "application/json"

    EventMalfaconCreate:
      allOf:
        - $ref: "#/components/schemas/Event"
        - properties:
            data:
              $ref: "#/components/schemas/MalfaconBase"

    EventMalfaconUpdate:
      allOf:
        - $ref: "#/components/schemas/Event"
        - properties:
            data:
              $ref: "#/components/schemas/MalfaconBase"

    EventMalfaconNote:
      allOf:
        - $ref: "#/components/schemas/Event"
        - properties:
            data:
              $ref: "#/components/schemas/Note"

    EventMalfaconAttachmentCreate:
      allOf:
        - $ref: "#/components/schemas/Event"
        - properties:
            data:
              $ref: "#/components/schemas/AttachmentMalfacon"

    EventMalfaconAttachmentUpdate:
      allOf:
        - $ref: "#/components/schemas/Event"
        - properties:
            data:
              $ref: "#/components/schemas/AttachmentMalfacon"

    RelatedMalfacon:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/RelatedEntity.openapi.yaml#/components/schemas/RelatedEntity
        - properties:
            "@referredType":
              type: string
              default: "Malfacon"
            role:
              type: string
              default: "troubleTicket"

    PM:
      $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/PM

    PBO:
      $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/PBO

    PTO:
      $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/PTO

    MalfaconOpticalRoutePlanned:
      allOf:
        - $ref: "#/components/schemas/OpticalRoute"
        - properties:
            "@type":
              type: string
              example: MalfaconOpticalRoutePlanned
          required:
            - name
            - position
            - noteTube
            - noteFiber

    MalfaconOpticalRouteObservedPBO:
      allOf:
        - $ref: "#/components/schemas/OpticalRoute"
        - properties:
            "@type":
              type: string
              example: MalfaconOpticalRouteObserved
          required:
            - noteTube
            - noteFiber

    MalfaconOpticalRouteObservedPM:
      allOf:
        - $ref: "#/components/schemas/OpticalRoute"
        - properties:
            "@type":
              type: string
              example: MalfaconOpticalRouteObservedPM
            referenceONT:
              description: n° de série ou adresse Mac de l’ONT
              type: string
          required:
            - name
            - position

    MalfaconOpticalRouteFinal:
      required:
        - name
        - position
        - noteTube
        - noteFiber
      description: |
        n’est pas obligatoire pour l’OI mais doit être renseignée par l’OC quand il corrige
      allOf:
        - $ref: "#/components/schemas/OpticalRoute"
        - properties:
            "@type":
              example: MalfaconOpticalRouteFinal
              type: string
            dechargeNumber:
              description: n° de décharge issue de la demande de mutation
              type: string
            note:
              description: explication des corrections apportées, ou blocage rencontré, par l’OC
              type: string
            referencePTO:
              description: Référence du PTO
              type: string
            referencePBO:
              description: Référence du PBO
              type: string

    MalfaconOpticalRoutePM:
      description: Pour les routes optiques obligatoires, il faut mettre la valeur "UNKNOWN" pour les champs inconnus qui sont obligatoires.
      required:
        - observed
        - planned
      properties:
        planned:
          $ref: "#/components/schemas/MalfaconOpticalRoutePlanned"
        observed:
          $ref: "#/components/schemas/MalfaconOpticalRouteObservedPM"
        final:
          $ref: "#/components/schemas/MalfaconOpticalRouteFinal"
        referencePTO:
          description: Référence du PTO
          type: string
        referencePrestationPrise:
          description: Référence Prestation Prise
          type: string

    MalfaconOpticalRoutePBO:
      description: Pour les routes optiques obligatoire, il faut mettre la valeur "UNKNOWN" pour les champs inconnus qui sont obligatoires.
      required:
        - observed
        - planned
      properties:
        planned:
          $ref: "#/components/schemas/MalfaconOpticalRoutePlanned"
        observed:
          $ref: "#/components/schemas/MalfaconOpticalRouteObservedPBO"
        final:
          $ref: "#/components/schemas/MalfaconOpticalRouteFinal"
        referencePTO:
          description: Référence du PTO
          type: string

    OpticalRoute:
      discriminator:
        propertyName: "@type"
        mapping:
          "optical.route.planned": "#/components/schemas/MalfaconOpticalRoutePlanned"
          "optical.route.observed.pbo": "#/components/schemas/MalfaconOpticalRouteObservedPBO"
          "optical.route.observed.pm": "#/components/schemas/MalfaconOpticalRouteObservedPM"
          "optical.route.final": "#/components/schemas/MalfaconOpticalRouteFinal"
      properties:
        "@baseType":
          type: string
          example: OpticalRoute
        "@type":
          type: string
          example: OpticalRoute
          description: |
            Les valeurs possibles sont :
            * `optical.route.planned`: `#/components/schemas/MalfaconOpticalRoutePlanned`
            * `optical.route.observed.pbo`: `#/components/schemas/MalfaconOpticalRouteObservedPBO`
            * `optical.route.observed.pm`: `#/components/schemas/MalfaconOpticalRouteObservedPM`
            * `optical.route.final`: `#/components/schemas/MalfaconOpticalRouteFinal`

        name:
          description: Nom du module PM
          type: string
        noteFiber:
          description: ajout d'information concernant la fibre
          type: string
        noteTube:
          description: ajout d'information concernant le tube
          type: string
        position:
          description: Position du module PM
          type: string

  parameters:
    malfaconId:
      name: malfaconId
      in: path
      description: The malfacon id
      required: true
      schema:
        type: string

    attachmentId:
      name: attachmentId
      in: path
      description: The attachment id
      required: true
      schema:
        type: string

    chunkIndex:
      name: chunkIndex
      in: path
      description: The chunk index
      required: true
      schema:
        type: string
