openapi: 3.1.0

info:
  title: Malfacon API
  version: 2.0.0
  license:
    name: Apache 2.0
    identifier: Apache-2.0
  description: |
    Cet outil permet la déclaration et le traitement d'une malfaçon grâce à des flux normalisés.

    ## Dépendances

    Cette API est basé sur les APIs outils du [projet common](https://github.com/before-interop/common):

    * [TroubleTicket](https://before-interop.github.io/common/?urls.primaryName=TroubleTicket)
    * [Attachment](https://before-interop.github.io/common/?urls.primaryName=Attachment)
    * [Event](https://before-interop.github.io/common/?urls.primaryName=Event)

    ## Pagination

    Les listes de ressources sont paginées.

    * La valeur par défaut d'une page est `limit=50` et `offset=0`.
    * La valeur maximale de `limit` est `100`.
servers:
  - url: "{protocol}://{host}:{port}{basePath}/malfacon"
    variables:
      protocol:
        enum:
          - https
          - http
        default: https
      host:
        default: localhost
      port:
        default: "8080"
      basePath:
        default: /api

tags:
  - name: TroubleTicket
    description: TroubleTicket management
  - name: Attachment
    description: Attachment management
  - name: Event
    description: Event management
  - name: OI
    description: OI endpoints
  - name: OC
    description: OC endpoints

paths:
  /:
    get:
      tags:
        - TroubleTicket
        - OI
      summary: Get all trouble tickets
      description: Get all trouble tickets
      operationId: getTroubleTickets
      parameters: &searchAndPaginateParameters
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/parameters/limit
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/parameters/offset
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/parameters/sort
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/fields.openapi.yaml#/components/parameters/fields
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The list of trouble tickets
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MalfaconAny"
        "400": &response400
          description: |
            **Bad Request**

            This error occurs when a query parameter or the body is invalid.

            * The `reason` field of the error response can contain information about the error.
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/Error-400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - TroubleTicket
        - OI
      summary: Count the number of trouble tickets
      description: Count the number of trouble tickets matching the given criteria.
      operationId: countTroubleTickets
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of trouble tickets.
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Error.openapi.yaml#/components/schemas/Error

    post:
      tags:
        - TroubleTicket
        - OI
      summary: Create a trouble ticket
      description: Create a trouble ticket
      operationId: createTroubleTicket
      requestBody:
        description: The malfacon to create
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MalfaconOne"
      responses:
        "201": &troubleTicket201
          description: The created malfacon
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MalfaconOne"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/update.openapi.yaml#/components/headers/ETag
        "400": *response400
        "403": &response403
          description: |
            **Forbidden**

            Le serveur a compris la requête, mais refuse de l'exécuter car le client n'a pas respecté le processus de création ou de mise à jour.

            Exemple: passage du status `ACKNOWLEDGED` à `RESOLVED` sans passer par le status `IN_PROGRESS`.

            * Le champ `reason` de la réponse d'erreur doit contenir la liste des tickets en conflit séparés par des virgules.
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Error.openapi.yaml#/components/schemas/Error

  /{malfaconId}:
    parameters:
      - $ref: "#/components/parameters/malfaconId"

    get:
      tags:
        - TroubleTicket
        - OI
      summary: Get a trouble ticket
      description: Get a trouble ticket
      operationId: getTroubleTicket
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/fields.openapi.yaml#/components/parameters/fields
      responses:
        "200":
          description: The malfacon
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MalfaconOne"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/update.openapi.yaml#/components/headers/ETag
        "404": &response404
          description: |
            **Not Found**

            This error occurs when the resource does not exist or is not visible by the user.
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/Error-404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Error.openapi.yaml#/components/schemas/Error

    put:
      tags:
        - TroubleTicket
        - OI
      summary: Update a trouble ticket
      description: Update a trouble ticket
      operationId: updateTroubleTicket
      requestBody:
        description: The trouble ticket to update
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MalfaconOne"
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/update.openapi.yaml#/components/parameters/If-Match
      responses:
        "200": *troubleTicket201
        "400": *response400
        "403": *response403
        "404": *response404
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/Error-412
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    patch:
      tags:
        - TroubleTicket
        - OI
      summary: Partially update a trouble ticket
      description: Partially update a trouble ticket
      operationId: patchTroubleTicket
      requestBody:
        description: The data to update
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MalfaconOne"
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/update.openapi.yaml#/components/parameters/If-Match
      responses:
        "200": *troubleTicket201
        "400": *response400
        "403": *response403
        "404": *response404
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/Error-412
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

  /{malfaconId}/attachment:
    parameters:
      - $ref: "#/components/parameters/malfaconId"

    get:
      tags:
        - Attachment
        - OI
      summary: List attachments
      description: Get all attachments of a trouble ticket
      operationId: getAttachments
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of attachments
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Attachment"
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Attachment
        - OI
      summary: Get the number of attachments
      description: This method returns the number of attachments matching the criteria.
      operationId: countAttachments
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of attachments
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Attachment
        - OI
      summary: Create a attachment
      description: This method allows to create a attachment.
      operationId: createAttachment
      requestBody:
        description: The attachment to create
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/AttachmentFormData"
      responses:
        "201":
          description: The created attachment
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Attachment"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/update.openapi.yaml#/components/headers/ETag
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

  /{malfaconId}/attachment/{attachmentId}/content:
    parameters:
      - $ref: "#/components/parameters/malfaconId"
      - $ref: "#/components/parameters/attachmentId"

    get:
      tags:
        - Attachment
        - OI
      summary: Download the content of an attachment
      description: This method allows to download the content of an attachment.
      operationId: downloadAttachment
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Match
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/tools/attachment/attachment.openapi.yaml#/components/parameters/If-None-Match
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Modified-Since
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Unmodified-Since
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/tools/attachment/attachment.openapi.yaml#/components/parameters/Range
      responses:
        "200":
          description: The content of the attachment
          content:
            application/octet-stream: {}
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/Error-412

  /event:
    get:
      tags:
        - Event
        - OI
      summary: Get all events of all trouble tickets
      description: Get all events of all trouble tickets
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of events
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Event"
        "400": *response400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Event
        - OI
      summary: Count the number of events of all trouble tickets
      description: Count the number of events of all trouble tickets matching the given criteria.
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of events
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Event
        - OC
      summary: Receive an event for a trouble ticket
      description: Receive an event for a trouble ticket
      requestBody:
        description: The event to receive
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Event"
      responses:
        default:
          description: |
            L'événement a été reçu avec succès.

            La réponse n'a pas l'obligation de contenir un body.
            Si l'OC retourne un body, celui-ci pourra être enregistré dans le journal de l'OI.
        4xx:
          description: |
            Erreur lors de la réception de l'événement.

            L'OI ne doit pas retransmettre l'événement à l'OC.

            La réponse n'a pas l'obligation de contenir un body.
            Si l'OC retourne un body, celui-ci pourra être enregistré dans le journal de l'OI.
        5xx:
          description: |
            Erreur lors de la réception de l'événement.

            L'OI peut retransmettre l'événement à l'OC.

            La réponse n'a pas l'obligation de contenir un body.
            Si l'OC retourne un body, celui-ci pourra être enregistré dans le journal de l'OI.

components:
  schemas:
    MalfaconAny:
      anyOf:
        - $ref: "#/components/schemas/MalfaconOiAny"
        - $ref: "#/components/schemas/MalfaconOcAny"

    MalfaconOne:
      oneOf:
        - $ref: "#/components/schemas/MalfaconOiOne"
        - $ref: "#/components/schemas/MalfaconOcOne"

    MalfaconOiAny:
      anyOf:
        - $ref: "#/components/schemas/MalfaconOiPm"
        - $ref: "#/components/schemas/MalfaconOiAmontPm"
        - $ref: "#/components/schemas/MalfaconOiPbo"
        - $ref: "#/components/schemas/MalfaconOiCcf"

    MalfaconOiOne:
      oneOf:
        - $ref: "#/components/schemas/MalfaconOiPm"
        - $ref: "#/components/schemas/MalfaconOiAmontPm"
        - $ref: "#/components/schemas/MalfaconOiPbo"
        - $ref: "#/components/schemas/MalfaconOiCcf"

    MalfaconOcAny:
      anyOf:
        - $ref: "#/components/schemas/MalfaconOcPm"
        - $ref: "#/components/schemas/MalfaconOcAmontPm"
        - $ref: "#/components/schemas/MalfaconOcPmPbo"
        - $ref: "#/components/schemas/MalfaconOcPbo"
        - $ref: "#/components/schemas/MalfaconOcCcf"

    MalfaconOcOne:
      oneOf:
        - $ref: "#/components/schemas/MalfaconOcPm"
        - $ref: "#/components/schemas/MalfaconOcAmontPm"
        - $ref: "#/components/schemas/MalfaconOcPmPbo"
        - $ref: "#/components/schemas/MalfaconOcPbo"
        - $ref: "#/components/schemas/MalfaconOcCcf"

    MalfaconBase:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/TroubleTicket.openapi.yaml#/components/schemas/TroubleTicket
      required:
        - code_oi
        - code_oc
        - "@type"
        - severity
        - quantity
        - localizationDetails
        - codeFault
      properties:
        code_oi:
          description: Code ARCEP de l'OI.
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Interop.openapi.yaml#/components/schemas/CodeOperateurArcep
        code_oc:
          description: Code ARCEP de l'OC.
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Interop.openapi.yaml#/components/schemas/CodeOperateurArcep
        externalId:
          description: Référence du ticket créé dans le système de l'OC
        codeInsee:
          type: string
          required: true
        codeFault:
          type: string
          description: |
            Code du défaut de la malfacon.

            Liste des valeurs possibles:

            | Code | valeur                                                                                 |
            | ---- | -------------------------------------------------------------------------------------- |
            | FD01 | absence de gaine demi-lune pour protéger câble PBO aérien, poteau ou façade            |
            | FD02 | absence protection obligatoire gaine fendue, demi-lune, …                              |
            | FD03 | bilan optique non conforme aux STAS                                                    |
            | FD04 | boîtier PBO non/mal étiqueté hors échec production                                     |
            | FD05 | boîtier PBO non/mal refermé, non/mal refixé,…                                          |
            | FD06 | bouchon absent                                                                         |
            | FD07 | brassage existant encombrant le cheminement                                            |
            | FD08 | brassage OC non conforme                                                               |
            | FD09 | caractéristiques tiroir non conforme aux STAS                                          |
            | FD10 | caractéristiques non conformes aux STAS                                                |
            | FD11 | cheminement câble OC/OI non conforme                                                   |
            | FD12 | cheminement non conforme aux STAS                                                      |
            | FD13 | cheminement non conforme surplomb domaine privé, …                                     |
            | FD14 | cordon non conforme aux STAS caractéristiques techniques                               |
            | FD15 | dégradation                                                                            |
            | FD16 | dégradation du support PBO poteau                                                      |
            | FD17 | dégradation majeure                                                                    |
            | FD18 | dégradation porte                                                                      |
            | FD19 | dégradation serrure                                                                    |
            | FD20 | dégradation tambours                                                                   |
            | FD21 | dégradation tiroirs cassés                                                             |
            | FD22 | environnement nettoyage déchets, fermeture                                             |
            | FD23 | épissure non conforme dénudage, protection de soudure                                  |
            | FD24 | étiquetage du PM non conforme hors échec de production                                 |
            | FD25 | étiquetage non conforme aux STAS                                                       |
            | FD26 | implantation ou étiquetage non conforme aux STAS                                       |
            | FD27 | implantation tiroir OC/OI ou étiquetage non conforme                                   |
            | FD28 | localisation non conforme aux données OI commande accès hors échec production          |
            | FD29 | lovage fibre non conforme aux STAS                                                     |
            | FD30 | lovage câble en chambre ou poteau non conforme aux STAS                                |
            | FD31 | mauvaise fixation                                                                      |
            | FD32 | mauvaise fixation ou fermeture dégradée                                                |
            | FD33 | modularité du câble CCF non conforme                                                   |
            | FD34 | nettoyage chantier                                                                     |
            | FD35 | entrée de cable PBO non conforme aux STAS                                              |
            | FD36 | non respect Route Optique communiquée                                                  |
            | FD37 | non utilisable pas d'autorisation de cheminement                                       |
            | FD38 | non utilisable risque de surplomb, sécurisé                                            |
            | FD39 | passage de câble non conforme                                                          |
            | FD40 | pose non conforme implantation ou fixation                                             |
            | FD41 | présence de cordons à zéro non retirés                                                 |
            | FD42 | présence de cordons non conformes                                                      |
            | FD43 | PTO mal ou non étiquetée                                                               |
            | FD44 | raccordement de site non déployé dans IPE                                              |
            | FD45 | rebouchage non effectué                                                                |
            | FD46 | reprise sauvage Route Optique par casse soudure au PBO                                 |
            | FD47 | taille SMOOVE non conforme                                                             |
            | FD48 | tiroir OI dégradé                                                                      |
            | FD49 | type de pose/fixation non conforme aux préconisations OI                               |

        quantity:
          description: |
            The volumetry of the malfacon.
          type: integer
          example: 1
        recoveryQuantity:
          description: |
            Ce champs indique la quantité de malfaçon reprise. 
            C'est un entier qui doit être renseignée au moment du passage en Resolved, par l'OC ou par l'OI suivant le cas de gestion, 
            et donc la valeur doit être >= au champs quantity renseigné à l'initialisation du ticket.
          type: integer
        localizationDetails:
          type: string
          description: |
            Détails de localisation de la malfacon

            Liste des valeurs possibles:

            | Code | valeur                                                                                 |
            | ---- | -------------------------------------------------------------------------------------- |
            | LD01 | AMONT_PM_INSTALLATION                                                                  |
            | LD02 | ARMOIRE                                                                                |
            | LD03 | BOITIER                                                                                |
            | LD04 | BRASSAGE_OC                                                                            |
            | LD05 | CABLE_CARACTERISTIQUE                                                                  |
            | LD06 | CABLE_INSTALLATION                                                                     |
            | LD07 | CASSETTE                                                                               |
            | LD08 | COLLECTE_LIEN_PM_PRDM                                                                  |
            | LD09 | CONNECTEUR_TIROIR_ZAPM                                                                 |
            | LD10 | ENTREE_DE_CABLE_PBO                                                                    |
            | LD11 | PBO_ENVIRONNEMENT                                                                      |
            | LD12 | PM_PBO_INSTALLATION                                                                    |
            | LD13 | PTO_CARACTERISTIQUE                                                                    |
            | LD14 | PTO_INSTALLATION                                                                       |
            | LD15 | ROUTE_OPTIQUE                                                                          |
            | LD16 | TIROIR_OC                                                                              |
            | LD17 | TIROIR_ZAPM                                                                            |
            | LD18 | ADDUCTION_OC                                                                           |

        "@type":
          readOnly: false
        "@baseType":
          default: Malfacon
          const: Malfacon
        severity:
          description: |
            The severity of the malfacon

            Allowed values are:

            * `CRITICAL`

              Si la malfaçon représente un danger grave est imminent pour les personnes,
              l'OI se réserve le droit d'effectuer la reprise ou à minima sécurise les lieux
              et demande à l'OC d'intervenir.

              De son côté, l'OC se doit de signaler à l'OI toute malfaçon
              représentant un danger grave et imminent pour les personnes.

            * `MAJOR`

              La malfaçon signifie une détérioration du site technique ou un risque d'intéruption
              massive de service (dérangement collectif) ou un empêchement à produire
              de nouveaux client (depuis le passage de commande jusqu'au raccordement).

              Exemples:

              * défaut d'étanchéité sur PB
              * PM ouvert
              * site insalubre
              * brassage encombrant
              * données de localisation erronées

            * `MINOR`

              Les autres non conformités à corriger.
          enum:
            - CRITICAL
            - MAJOR
            - MINOR
        status:
          description: |
            Status de la malfacon.

            ![Malfacon status diagram](./statusOiOcImput.drawio.svg)
          enum:
            - ACKNOWLEDGED
            - CANCELED
            - CLOSED
            - CREATING
            - IN_PROGRESS
            - PENDING
            - REJECTED
            - RESOLVED
          default: CREATING

    MalfaconOcBase:
      allOf:
        - $ref: "#/components/schemas/MalfaconBase"
      required:
        - statusChangeReason
      properties:
        statusChangeReason:
          enum:
            - ACKNOWLEDGED
            - CLOSED
            - CREATING
          default: CREATING

    MalfaconOiBase:
      allOf:
        - $ref: "#/components/schemas/MalfaconBase"
      required:
        - attributable
        - ocNumber
        - resolutionOwner
        - statusChangeReason
      properties:
        attributable:
          type: boolean
        ocNumber:
          description: Nombre d'OCs concernés par la malfaçon
          type: number
        resolutionOwner:
          type: string
          readOnly: true
          enum:
            - OI
            - OC
          default: OC
        statusChangeReason:
          enum:
            - ACKNOWLEDGED
            - ATTRIBUTABLE_ACCEPTED
            - CANCELED
            - CONTESTATION_ACCEPTED
            - CONTESTATION_DUPLICATE
            - CONTESTATION_EQUIPMENT_ERROR
            - CONTESTATION_NOT_ALLOWED
            - CONTESTATION_OC_ERROR
            - CONTESTATION_OI_RESPONSABILITY
            - CONTESTATION_ORDER_PUT_INTO_SERVICE_FOR_MORE_THAN_A_YEAR
            - CONTESTATION_PHOTO_NOT_USABLE
            - CONTESTATION_REFUSED
            - CREATING
            - CRITICAL
            - INFORMATION_GIVEN
            - INFORMATION_REQUEST
            - INVALID_FORMAT
            - NON_ATTRIBUTABLE
            - OC_RESOLUTION_DELAY_EXPIRED
            - OI_RESOLUTION_IMPOSSIBLE
            - OI_RESOLUTION_RENUNCIATION
            - OI_RESPONSE_DELAY_EXPIRED
            - OI_VALIDATION_DELAY_EXPIRED
            - RESOLUTION_REFUSED_EQUIPMENT_ERROR
            - RESOLUTION_REFUSED_NOT_REPAIRED
            - RESOLUTION_REFUSED_PARTIALLY_RESOLVED
            - RESOLUTION_REFUSED_PHOTO_NOT_USABLE
            - RESOLVED_OC
            - RESOLVED_OC_VALIDATED
            - RESOLVED_OI_ATTRIBUTABLE
            - RESOLVED_OI_CRITICAL
            - RESOLVED_OI_NON_ATTRIBUTABLE
            - RESOLVED_OI_VALIDATED
          default: CREATING
        maxResolutionOcDuration:
          properties:
            value:
              type: integer
              description: Duration in seconds
              readOnly: true
            reason:
              type: string
              readOnly: true
        totalResolutionOcDuration:
          description: The OC resolution duration in seconds. Calculated only as long as ResolutionOwner = OC
          type: number
        expectedResolutionDate:
          description: The maximum OC resolution date, recalculated only during state changes taking into account the ticket creation date and successive pauses.
          type: string
          format: date
        validationDueDate:
          description: The deadline for validation status
          type: string
          format: date
        pendingDueDate:
          description: The deadline for pending status
          type: string
          format: date

    MalfaconOiPm:
      allOf:
        - $ref: "#/components/schemas/MalfaconOiBase"
      required:
        - pm
      properties:
        "@type":
          const: malfacon.pm.oi
        localizationDetails:
          enum:
            - LD02
            - LD04
            - LD09
            - LD17
        codeFault:
          enum:
            - FD06
            - FD09
            - FD12
            - FD14
            - FD17
            - FD18
            - FD19
            - FD20
            - FD21
            - FD22
            - FD26
            - FD31
            - FD36
            - FD41
            - FD42
        pm:
          $ref: "#/components/schemas/PM"

    MalfaconOiAmontPm:
      allOf:
        - $ref: "#/components/schemas/MalfaconOiBase"
      required:
        - pm
      properties:
        "@type":
          const: malfacon.oi.amontpm
        localizationDetails:
          enum:
            - LD08
            - LD18
        codeFault:
          enum:
            - FD06
            - FD08
            - FD11
            - FD27
        pm:
          $ref: "#/components/schemas/PM"

    MalfaconOiPbo:
      allOf:
        - $ref: "#/components/schemas/MalfaconOiBase"
      required:
        - pbo
      properties:
        "@type":
          const: malfacon.pbo.oi
        localizationDetails:
          enum:
            - LD03
            - LD07
            - LD11
            - LD15
        codeFault:
          enum:
            - FD04
            - FD05
            - FD15
            - FD16
            - FD23
            - FD29
            - FD30
            - FD34
            - FD36
            - FD44
            - FD46
            - FD47
        pbo:
          $ref: "#/components/schemas/PBO"

    MalfaconOiCcf:
      allOf:
        - $ref: "#/components/schemas/MalfaconOiBase"
      properties:
        "@type":
          const: malfacon.ccf.oi
        localizationDetails:
          enum:
            - LD05
            - LD06
            - LD10
            - LD13
            - LD14
        codeFault:
          enum:
            - FD02
            - FD03
            - FD10
            - FD13
            - FD37
            - FD38
            - FD40
            - FD43
        refOrder:
          description: Référence de la commande
          type: string
        localization:
          description: Localisation GPS du câble
          $ref: "#/components/schemas/Localization"
        pbo:
          $ref: "#/components/schemas/PBO"
        pto:
          $ref: "#/components/schemas/PTO"

    MalfaconOcPm:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
      required:
        - pm
      properties:
        "@type":
          const: malfacon.pm.oc
        localizationDetails:
          enum:
            - LD02
            - LD04
            - LD09
            - LD17
        codeFault:
          enum:
            - FD06
            - FD07
            - FD14
            - FD18
            - FD19
            - FD20
            - FD21
            - FD22
            - FD24
            - FD31
            - FD42
        pm:
          $ref: "#/components/schemas/PM"

    MalfaconOcAmontPm:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
      required:
        - pm
      properties:
        "@type":
          const: malfacon.amontpm.oc
        localizationDetails:
          enum:
            - LD01
            - LD08
            - LD18
        codeFault:
          enum:
            - FD06
            - FD11
            - FD27
            - FD39
            - FD48
        pm:
          $ref: "#/components/schemas/PM"

    MalfaconOcPmPbo:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
      required:
        - pm
        - pbo
      properties:
        "@type":
          const: malfacon.pmpbo.oc
        localizationDetails:
          enum:
            - LD12
        codeFault:
          enum:
            - FD01
            - FD15
        pm:
          $ref: "#/components/schemas/PM"
        pbo:
          $ref: "#/components/schemas/PBO"

    MalfaconOcPbo:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
      properties:
        "@type":
          const: malfacon.pbo.oc
        localizationDetails:
          enum:
            - LD03
            - LD07
            - LD11
        codeFault:
          enum:
            - FD04
            - FD15
            - FD16
            - FD28
            - FD29
            - FD30
            - FD34
        pbo:
          $ref: "#/components/schemas/PBO"

    MalfaconOcCcf:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
      required:
        - pbo
        - pto
      properties:
        "@type":
          const: malfacon.ccf.oc
        localizationDetails:
          enum:
            - LD05
            - LD06
            - LD10
        codeFault:
          enum:
            - FD02
            - FD03
            - FD10
            - FD13
            - FD15
            - FD25
            - FD34
            - FD35
            - FD37
            - FD38
            - FD45
            - FD49
        refOrder:
          description: Référence de la commande
          type: string
        localization:
          description: Localisation GPS du câble
          $ref: "#/components/schemas/Localization"
        pbo:
          $ref: "#/components/schemas/PBO"
        pto:
          $ref: "#/components/schemas/PTO"

    Localization:
      $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Interop.openapi.yaml#/components/schemas/GeographicPoint

    Attachment:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Attachment.openapi.yaml#/components/schemas/Attachment
      description: |
        An attachment is a file that is attached to an entity.

        Only JPEG images are allowed.

        Extensions:

        * `.csv`
        * `.docx`
        * `.jpeg`
        * `.jpg`
        * `.ods`
        * `.odt`
        * `.pdf`
        * `.png`
        * `.svg`
        * `.xlsx`

        Mime types:

        * `application/pdf`
        * `application/vnd.oasis.opendocument.spreadsheet`
        * `application/vnd.oasis.opendocument.text`
        * `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`
        * `application/vnd.openxmlformats-officedocument.wordprocessingml.document`
        * `image/jpeg`
        * `image/jpg`
        * `image/png`
        * `image/svg+xml`
        * `test/csv`
      properties:
        proofType:
          enum:
            - ISSUE
            - RESOLUTION
          default: ISSUE
        primary:
          type: boolean
          description: Specify if this is the main attachment. There can only be one primary attachment for each type.
          default: true
        mimeType:
          enum:
            - application/pdf
            - application/vnd.oasis.opendocument.spreadsheet
            - application/vnd.oasis.opendocument.text
            - application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
            - application/vnd.openxmlformats-officedocument.wordprocessingml.document
            - image/jpeg
            - image/jpg
            - image/png
            - image/svg+xml
            - test/csv
        status:
          enum:
            - PENDING
            - VALIDATED
            - REJECTED
        relatedEntity:
          description: Reference to the malfacon
          minItems: 1
          maxItems: 1
          readOnly: true
          items:
            allOf:
              - $ref: "#/components/schemas/RelatedMalfacon"

    AttachmentFormData:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/tools/attachment/attachment.openapi.yaml#/components/schemas/AttachmentFormData
      properties:
        attachment:
          $ref: "#/components/schemas/Attachment"

    Event:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/CloudEvent.openapi.yaml#/components/schemas/CloudEvent
      required:
        - time
        - subject
      properties:
        subject:
          description: Identifiant unique de la malfaçon.
          type: string
          format: uuid
        type:
          enum:
            - fr.interop.malfacon.create
            - fr.interop.malfacon.update
            - fr.interop.malfacon.attachment.create
            - fr.interop.malfacon.attachment.update
        datacontenttype:
          const: application/json
        data:
          oneOf:
            - $ref: "#/components/schemas/MalfaconOne"
            - $ref: "#/components/schemas/Attachment"

    RelatedMalfacon:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/RelatedEntity.openapi.yaml#/components/schemas/RelatedEntity
      properties:
        "@referredType":
          const: "Malfacon"
        role:
          const: "troubleTicket"

    PM:
      $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Interop.openapi.yaml#/components/schemas/PM

    PBO:
      $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Interop.openapi.yaml#/components/schemas/PBO

    PTO:
      $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Interop.openapi.yaml#/components/schemas/PTO

  parameters:
    malfaconId:
      name: malfaconId
      in: path
      description: The malfacon id
      required: true
      schema:
        type: string

    attachmentId:
      name: attachmentId
      in: path
      description: The attachment id
      required: true
      schema:
        type: string
