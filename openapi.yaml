openapi: 3.1.0

info:
  title: Malfacon API
  version: 2.0.0
  license:
    name: Apache 2.0
    identifier: Apache-2.0
  description: |
    Cet outil permet la déclaration et le traitement d'une malfaçon grâce à des flux normalisés.

    ## Lexique

    #### OI

    Opérateur d'immeuble:
    Toute personne chargée de l'établissement ou de la gestion d'une ou plusieurs lignes dans un immeuble bâti,
    notamment dans le cadre d'une convention d'installation, d'entretien, de remplacement ou de gestion
    des lignes signée avec le propriétaire ou le syndicat de copropriétaires,
    en application de l'article L. 33-6 du code des postes et des communications électroniques ;
    l'opérateur d'immeuble n'est pas nécessairement un opérateur au sens de l'article L. 33-1 du même code.

    #### OC

    Opérateur Commercial
    Opérateur choisi par le client final pour la fourniture d'un service de télécommunications
    ou par un fournisseur d'accès au service pour la fourniture d'un service de télécommunications
    à son propre client final.

    #### Malfaçon

    Une malfaçon est une non-conformité issue de travaux menés dans le cadre
    d'une prestation de production ou de SAV sur un accès (PM/PBO/PTO),
    confiée à un intervenant selon un cahier des charges (STAS et règles de l'art).

    ## Processus

    1. La signalisation de malfaçons peut être faite par un OI vers OC comme par un OC vers un OI.

    2. Certaines malfaçons sont détectables aussi bien par un OI que par un OC,
        d'autres sont vues comme détectables uniquement par un OI ou uniquement par un OC.

    3. La signalisation de malfaçon par un OI vers un OC est une notification
        appelant action de la part de l'OC destinataire ou informant ce dernier
        d'une malfaçon n'appelant pas action de sa part.

        Cette notification suppose que l'OC pourra intervenir pour traiter la malfaçon:

        * Si les conditions font que c'est impossible et plus particulièrement sur un PM devenu inexploitable,
          alors l'OI doit procéder par une Remise En Conformité (REC)
        * Si l'OC constate lors de son intervention que l'état du PM ne lui permet pas de traiter la malfaçon,
          alors il aura la possibilité de le signaler en retour à l'OI.

    4. La signalisation de malfaçon par un OC vers un OI est une remontée d'information
        qui n'implique pas d'engagement de l'OC sur son niveau de précision:
        cette signalisation constitue une information complémentaire pour l'OI
        dans le cadre de l'exploitation de son réseau.

    5. De par sa définition, la Malfaçon se distingue de la notion de « Dysfonctionnement »
        dont est ici rappelée la définition Interop'Fibre:

            «
              Un dysfonctionnement est une problématique qui rend impossible
              l'adduction du réseau d'un OC au PM mis à disposition par un OI
            »

    6. A noter que les notions de « Dommages »,
        qui peuvent apparaître dans les contrats des OI, ne sont pas normalisées.
        Dans tous les cas, il est important que ces définitions contractuelles
        ne viennent pas recouvrir le périmètre de la Malfaçon.

    ## Types de signalement

    ![Types de signalement](./type.drawio.svg)

    ## Workflow

    ### Cycle de vie d'une Malfaçon Imputable OI vers OC non critique

    ![Cycle de vie d'une Malfaçon Imputable OI vers OC non critique](./statusOiOcImput.drawio.svg)

    **Possibilités de changement de status:**

    * `CREATING` → `ACKNOWLEDGED`: Ticket en cours de création.

      Le créateur du ticket peut fournir des pièces jointes et des notes à ce moment.

    * `ACKNOWLEDGED` → `IN_PROGRESS`: Le ticket est recevable.

      **Ce changement de status ne peut être effectué que par l'OC.**

      Il n'est plus possible de passer le ticket à `REJECTED` une fois ce changement de status effectué.

      Le temps de traitement est décompté à partir de ce changement de status (`totalInProgressDuration`).

    * `ACKNOWLEDGED` → `REJECTED`: Le ticket n'est pas recevable.

      **Ce changement de status ne peut être effectué que par l'OC.**

      **Ce changement de status n'est pas possible si le ticket a déjà été qualifié.**

      **L'OC doit fournir la durée d'analyse dans le champ `acknowledgedDuration`.**

      Les raisons (`statusChangeReason`) possibles sont:

      * `UNKNOWN_RESOURCE`: Le ticket ne peut pas être traité car le PM/PBO/PTO n'existe pas.

      * `DUPLICATE`: Le ticket est un doublon d'un ticket existant.

        Le ticket est en conflit avec un autre ticket (non respect du délai max de dépôt entre les tickets auprès d'un même OC sur un même élément d'infra ).

        * Le champ `statusChangeDetails` est obligatoire avec la référence du ticket en conflit.

      * `INVALID`: Le ticket est jugé invalide et/ou non analysable par l'OC.

        * Le champ `statusChangeDetails` est obligatoire avec la raison de l'invalidité.

    * `IN_PROGRESS` → `IN_PROGRESS`: l'OI prend en charge le ticket suite au dépacement de délai de traitement par l'OC.

      **Ce changement de status ne peut être effectué que par l'OI.**
      Celui-ci doit fournir les informations suivantes:

      * le champ `resolutionOwner` doit être renseigné à la valeur `OI`
      * le champ `statusChangeReason` doit être renseigné à la valeur `RESOLUTION_DATE_EXPIRED`

    * `IN_PROGRESS` → `PENDING`: L'OC demande des informations complémentaires à l'OI.

      **Ce changement de status ne peut être effectué que par l'OC.**

      * Le champ `statusChangeReason` doit être renseigné avec l'une des valeus suivantes:
        * `PHOTO_UNUSABLE`: Photo non exploitable (ex: flou, mal cadré)
        * `PHOTO_MISSING`: Photo manquante
        * `PM_ERROR`: Confusion entre identification du PM et PM déclaré
        * `CONTESTATION`: Contestation de la malfaçon. Cette transition n'est possible que deux fois par l'OC, sinon rejet OI.
        * `OTHER`: Autre raison

      * Le champ `statusChangeDetails` doit être renseigné avec la raison de la demande d'information.

    * `IN_PROGRESS` → `RESOLVED`: résolution du ticket

      * Si le ticket a le champ `resolutionOwner` à la valeur `OI`, **ce changement de status ne peut être effectué que par l'OI.**
        * Le champ `statusChangeReason` doit être renseigné à la valeur `RESOLVED_OI`.
        * Le champ `resolutionDate` doit être renseigné avec la date de résolution de l'OI.
        * Une photo prouvant la résolution doit être fournie en pièce jointe.

      * Si le ticket a le champ `resolutionOwner` à la valeur `OC`, **ce changement de status ne peut être effectué que par l'OC.**
        * Le champ `statusChangeReason` doit être renseigné à la valeur `RESOLVED_OC`.
        * Le champ `totalResolutionOcDuration` doit être rensigné avec la durée de résolution de l'OC.
        * Le champ `resolutionDate` doit être renseigné avec la date de résolution de l'OC.
        * Une photo prouvant la résolution doit être fournie en pièce jointe.

    * `PENDING` → `RESOLVED`: absence de réponse de la part de l'OI dans les délais.

      **Ce changement de status ne peut être effectué que par l'OI (automatiquement)**
      lorsque le délai de réponse OI a été dépassé (`maxPendingDate`).

      En absence de réponse OI, le ticket passe automatiquement à RESOLVED avec le champ `statusChangeReason` renseigné à `DELAY_ANSWER_EXPIRED`.

    * `RESOLVED` → `CLOSED`: clôture du ticket

      * Par validation explicite de la résolution fournie par l'OC (`resolutionOwner`=`OC`).
        Le champ `statusChangeReason` doit être renseigné à la valeur `RESOLUTION_ACCEPTED`.

      * Par validation explicite de la résolution fournie par l'OI (`resolutionOwner`=`OI`).
        Le champ `statusChangeReason` doit être renseigné à la valeur `RESOLUTION_ACCEPTED`.

      * automatiquement si le délai de validation a expiré.
        Le champ `statusChangeReason` doit être renseigné à la valeur `DELAY_VALIDATION_EXPIRED`.

    * `ACKNOWLEDGED|IN_PROGRESS|PENDING` → `CANCELLED`: Annulation de la malfaçon par l'OI

      **Ce changement de status ne peut être effectué que par l'OI.**

      Le temps de traitement est annulé à partir de ce changement de status.

      Le champ `statusChangeDetails` doit être renseigné avec la raison de l'annulation.

    ### Cycle de vie d'une Malfaçon Non imputable ou Critique de l'OI vers OC

    ![Cycle de vie d'une Malfaçon Non imputable ou Critique de l'OI vers OC](./statusOiOcNonImputCrit.drawio.svg)

    ### Cycle de vie d'une Malfaçon OC vers OI

    ![Cycle de vie d'une Malfaçon OC vers OI](./statusOcOi.drawio.svg)

    ## Pagination

    Les listes de ressources sont paginées.

    * La valeur par défaut d'une page est `limit=50` et `offset=0`.
    * La valeur maximale de `limit` est `100`.

    ## Dépendances

    Cette API utilise une architecture proxyfié pour la gestion des dépendances.

    ![Proxyfied architecture schema](https://raw.githubusercontent.com/before-interop/common/main/schema/architecture.drawio.svg)

    * [TroubleTicket](https://ggrebert.github.io/before-interop-common/?urls.primaryName=TroubleTicket)
    * [Attachment](https://ggrebert.github.io/before-interop-common/?urls.primaryName=Attachment)
    * [Note](https://ggrebert.github.io/before-interop-common/?urls.primaryName=Note)
    * [Event](https://ggrebert.github.io/before-interop-common/?urls.primaryName=Event)

servers:
  - url: "{protocol}://{host}:{port}{basePath}/malfacon"
    variables:
      protocol:
        enum:
          - https
          - http
        default: https
      host:
        default: localhost
      port:
        default: "8080"
      basePath:
        default: /api

tags:
  - name: TroubleTicket
    description: TroubleTicket management
  - name: Note
    description: Note management
  - name: Attachment
    description: Attachment management
  - name: Event
    description: Event management
  - name: OI
    description: OI endpoints
  - name: OC
    description: OC endpoints

paths:
  /:
    get:
      tags:
        - TroubleTicket
        - OI
      summary: Get all trouble tickets
      description: Get all trouble tickets
      operationId: getTroubleTickets
      parameters: &searchAndPaginateParameters
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/parameters/limit
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/parameters/offset
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/parameters/sort
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/fields.openapi.yaml#/components/parameters/fields
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The list of trouble tickets
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MalfaconAny"
        "400": &response400
          description: |
            **Bad Request**

            This error occurs when a query parameter or the body is invalid.

            * The `reason` field of the error response can contain information about the error.
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/Error-400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - TroubleTicket
        - OI
      summary: Count the number of trouble tickets
      description: Count the number of trouble tickets matching the given criteria.
      operationId: countTroubleTickets
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of trouble tickets.
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Error.openapi.yaml#/components/schemas/Error

    post:
      tags:
        - TroubleTicket
        - OI
      summary: Create a trouble ticket
      description: Create a trouble ticket
      operationId: createTroubleTicket
      requestBody:
        description: The malfacon to create
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MalfaconOiOne"
      responses:
        "201": &troubleTicket201
          description: The created malfacon
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MalfaconOiOne"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/update.openapi.yaml#/components/headers/ETag
        "400": *response400
        "403": &response403
          description: |
            **Forbidden**

            Le serveur a compris la requête, mais refuse de l'exécuter car le client n'a pas respecté le processus de création ou de mise à jour.

            Exemple: passage du status `ACKNOWLEDGED` à `RESOLVED` sans passer par le status `IN_PROGRESS`.

            * Le champ `reason` de la réponse d'erreur doit contenir la liste des tickets en conflit séparés par des virgules.
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Error.openapi.yaml#/components/schemas/Error

  /{malfaconId}:
    parameters:
      - $ref: "#/components/parameters/malfaconId"

    get:
      tags:
        - TroubleTicket
        - OI
      summary: Get a trouble ticket
      description: Get a trouble ticket
      operationId: getTroubleTicket
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/fields.openapi.yaml#/components/parameters/fields
      responses:
        "200":
          description: The malfacon
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MalfaconOne"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/update.openapi.yaml#/components/headers/ETag
        "404": &response404
          description: |
            **Not Found**

            This error occurs when the resource does not exist or is not visible by the user.
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/Error-404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Error.openapi.yaml#/components/schemas/Error

    put:
      tags:
        - TroubleTicket
        - OI
      summary: Update a trouble ticket
      description: Update a trouble ticket
      operationId: updateTroubleTicket
      requestBody:
        description: The trouble ticket to update
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MalfaconOne"
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/update.openapi.yaml#/components/parameters/If-Match
      responses:
        "200": *troubleTicket201
        "400": *response400
        "403": *response403
        "404": *response404
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/Error-412
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    patch:
      tags:
        - TroubleTicket
        - OI
      summary: Partially update a trouble ticket
      description: Partially update a trouble ticket
      operationId: patchTroubleTicket
      requestBody:
        description: The data to update
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MalfaconOne"
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/update.openapi.yaml#/components/parameters/If-Match
      responses:
        "200": *troubleTicket201
        "400": *response400
        "403": *response403
        "404": *response404
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/Error-412
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

  /{malfaconId}/note:
    parameters:
      - $ref: "#/components/parameters/malfaconId"

    get:
      tags:
        - Note
        - OI
      summary: Get all notes of a trouble ticket
      description: Get all notes of a trouble ticket
      operationId: getNotes
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of notes
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Note"
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Note
        - OI
      summary: Count the number of notes of a trouble ticket
      description: Count the number of notes of a trouble ticket matching the given criteria.
      operationId: countNotes
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of notes
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Note
        - OI
      summary: Create a note
      description: This method allows to create a note.
      operationId: createNote
      requestBody:
        description: The note to create
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Note"
      responses:
        "201":
          description: The created note
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Note"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/update.openapi.yaml#/components/headers/ETag
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

  /{malfaconId}/attachment:
    parameters:
      - $ref: "#/components/parameters/malfaconId"

    get:
      tags:
        - Attachment
        - OI
      summary: List attachments
      description: Get all attachments of a trouble ticket
      operationId: getAttachments
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of attachments
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Attachment"
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Attachment
        - OI
      summary: Get the number of attachments
      description: This method returns the number of attachments matching the criteria.
      operationId: countAttachments
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of attachments
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Attachment
        - OI
      summary: Create a attachment
      description: This method allows to create a attachment.
      operationId: createAttachment
      requestBody:
        description: The attachment to create
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/AttachmentFormData"
      responses:
        "201":
          description: The created attachment
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Attachment"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/update.openapi.yaml#/components/headers/ETag
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

  /{malfaconId}/attachment/{attachmentId}/content:
    parameters:
      - $ref: "#/components/parameters/malfaconId"
      - $ref: "#/components/parameters/attachmentId"

    get:
      tags:
        - Attachment
        - OI
      summary: Download the content of an attachment
      description: This method allows to download the content of an attachment.
      operationId: downloadAttachment
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Match
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/tools/attachment/attachment.openapi.yaml#/components/parameters/If-None-Match
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Modified-Since
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Unmodified-Since
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/tools/attachment/attachment.openapi.yaml#/components/parameters/Range
      responses:
        "200":
          description: The content of the attachment
          content:
            application/octet-stream: {}
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/Error-412

  /event:
    get:
      tags:
        - Event
        - OI
      summary: Get all events of all trouble tickets
      description: Get all events of all trouble tickets
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of events
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Event"
        "400": *response400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Event
        - OI
      summary: Count the number of events of all trouble tickets
      description: Count the number of events of all trouble tickets matching the given criteria.
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of events
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Event
        - OC
      summary: Receive an event for a trouble ticket
      description: Receive an event for a trouble ticket
      requestBody:
        description: The event to receive
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Event"
      responses:
        default:
          description: |
            L'événement a été reçu avec succès.

            La réponse n'a pas l'obligation de contenir un body.
            Si l'OC retourne un body, celui-ci pourra être enregistré dans le journal de l'OI.
        4xx:
          description: |
            Erreur lors de la réception de l'événement.

            L'OI ne doit pas retransmettre l'événement à l'OC.

            La réponse n'a pas l'obligation de contenir un body.
            Si l'OC retourne un body, celui-ci pourra être enregistré dans le journal de l'OI.
        5xx:
          description: |
            Erreur lors de la réception de l'événement.

            L'OI peut retransmettre l'événement à l'OC.

            La réponse n'a pas l'obligation de contenir un body.
            Si l'OC retourne un body, celui-ci pourra être enregistré dans le journal de l'OI.

components:
  schemas:
    MalfaconAny:
      anyOf:
        - $ref: "#/components/schemas/MalfaconOiAny"
        - $ref: "#/components/schemas/MalfaconOcAny"

    MalfaconOne:
      anyOf:
        - $ref: "#/components/schemas/MalfaconOiOne"
        - $ref: "#/components/schemas/MalfaconOcOne"

    MalfaconOiAny:
      anyOf:
        - $ref: "#/components/schemas/MalfaconOiPm"
        - $ref: "#/components/schemas/MalfaconOiAmontPm"
        - $ref: "#/components/schemas/MalfaconOiPmPbo"
        - $ref: "#/components/schemas/MalfaconOiPbo"
        - $ref: "#/components/schemas/MalfaconOiCcfCable"
        - $ref: "#/components/schemas/MalfaconOiCcfPto"

    MalfaconOiOne:
      oneOf:
        - $ref: "#/components/schemas/MalfaconOiPm"
        - $ref: "#/components/schemas/MalfaconOiAmontPm"
        - $ref: "#/components/schemas/MalfaconOiPmPbo"
        - $ref: "#/components/schemas/MalfaconOiPbo"
        - $ref: "#/components/schemas/MalfaconOiCcfCable"
        - $ref: "#/components/schemas/MalfaconOiCcfPto"

    MalfaconOcAny:
      anyOf:
        - $ref: "#/components/schemas/MalfaconOcPm"
        - $ref: "#/components/schemas/MalfaconOcAmontPm"
        - $ref: "#/components/schemas/MalfaconOcPmPbo"
        - $ref: "#/components/schemas/MalfaconOcPbo"
        - $ref: "#/components/schemas/MalfaconOcCcfCable"
        - $ref: "#/components/schemas/MalfaconOcCcfPto"

    MalfaconOcOne:
      oneOf:
        - $ref: "#/components/schemas/MalfaconOcPm"
        - $ref: "#/components/schemas/MalfaconOcAmontPm"
        - $ref: "#/components/schemas/MalfaconOcPmPbo"
        - $ref: "#/components/schemas/MalfaconOcPbo"
        - $ref: "#/components/schemas/MalfaconOcCcfCable"
        - $ref: "#/components/schemas/MalfaconOcCcfPto"

    MalfaconBase:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/TroubleTicket.openapi.yaml#/components/schemas/TroubleTicket
      required:
        - codeOi
        - codeOc
        - "@type"
        - severity
        - volumetry
        - localizationDetails
        - codeFault
      properties:
        codeOi:
          description: Code ARCEP de l'OI.
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Interop.openapi.yaml#/components/schemas/CodeOperateurArcep
        codeOc:
          description: Code ARCEP de l'OC.
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Interop.openapi.yaml#/components/schemas/CodeOperateurArcep
        externalId:
          description: Référence du ticket créé dans le système de l'OC
        codeFault:
          type: string
          description: |
            Code du défaut de la malfacon.

            Liste des valeurs possibles:

            | Code | valeur                                                                                 |
            | ---- | -------------------------------------------------------------------------------------- |
            | FD01 | absence de gaine demi-lune pour protéger câble PBO aérien, poteau ou façade            |
            | FD02 | absence protection obligatoire gaine fendue, demi-lune, …                              |
            | FD03 | bilan optique non conforme aux STAS                                                    |
            | FD04 | boîtier PBO non/mal étiqueté hors échec production                                     |
            | FD05 | boîtier PBO non/mal refermé, non/mal refixé,…                                          |
            | FD06 | bouchon absent                                                                         |
            | FD07 | brassage existant encombrant le cheminement                                            |
            | FD08 | brassage OC non conforme                                                               |
            | FD09 | caractéristiques tiroir non conforme aux STAS                                          |
            | FD10 | caractéristiques non conformes aux STAS                                                |
            | FD11 | cheminement câble OC/OI non conforme                                                   |
            | FD12 | cheminement non conforme aux STAS                                                      |
            | FD13 | cheminement non conforme surplomb domaine privé, …                                     |
            | FD14 | cordon non conforme aux STAS caractéristiques techniques                               |
            | FD15 | dégradation                                                                            |
            | FD16 | dégradation du support PBO poteau                                                      |
            | FD17 | dégradation majeure                                                                    |
            | FD18 | dégradation porte                                                                      |
            | FD19 | dégradation serrure                                                                    |
            | FD20 | dégradation tambours                                                                   |
            | FD21 | dégradation tiroirs cassés                                                             |
            | FD22 | environnement nettoyage déchets, fermeture                                             |
            | FD23 | épissure non conforme dénudage, protection de soudure                                  |
            | FD24 | étiquetage du PM non conforme hors échec de production                                 |
            | FD25 | étiquetage non conforme aux STAS                                                       |
            | FD26 | implantation ou étiquetage non conforme aux STAS                                       |
            | FD27 | implantation tiroir OC/OI ou étiquetage non conforme                                   |
            | FD28 | localisation non conforme aux données OI commande accès hors échec production          |
            | FD29 | lovage fibre non conforme aux STAS                                                     |
            | FD30 | lovage câble en chambre ou poteau non conforme aux STAS                                |
            | FD31 | mauvaise fixation                                                                      |
            | FD32 | mauvaise fixation ou fermeture dégradée                                                |
            | FD33 | modularité du câble CCF non conforme                                                   |
            | FD34 | nettoyage chantier                                                                     |
            | FD35 | entrée de cable PBO non conforme aux STAS                                              |
            | FD36 | non respect Route Optique communiquée                                                  |
            | FD37 | non utilisable pas d'autorisation de cheminement                                       |
            | FD38 | non utilisable risque de surplomb, sécurisé                                            |
            | FD39 | passage de câble non conforme                                                          |
            | FD40 | pose non conforme implantation ou fixation                                             |
            | FD41 | présence de cordons à zéro non retirés                                                 |
            | FD42 | présence de cordons non conformes                                                      |
            | FD43 | PTO mal ou non étiquetée                                                               |
            | FD44 | raccordement de site non déployé dans IPE                                              |
            | FD45 | rebouchage non effectué                                                                |
            | FD46 | reprise sauvage Route Optique par casse soudure au PBO                                 |
            | FD47 | taille SMOOVE non conforme                                                             |
            | FD48 | tiroir OI dégradé                                                                      |
            | FD49 | type de pose/fixation non conforme aux préconisations OI                               |

        volumetry:
          description: |
            The volumetry of the malfacon.

            TODO: améliorer la description
          type: integer
          example: 1
        localizationDetails:
          type: string
          description: |
            Détails de localisation de la malfacon

            Liste des valeurs possibles:

            | Code | valeur                                                                                 |
            | ---- | -------------------------------------------------------------------------------------- |
            | LD01 | AMONT_PM_INSTALLATION                                                                  |
            | LD02 | ARMOIRE                                                                                |
            | LD03 | BOITIER                                                                                |
            | LD04 | BRASSAGE_OC                                                                            |
            | LD05 | CABLE_CARACTERISTIQUE                                                                  |
            | LD06 | CABLE_INSTALLATION                                                                     |
            | LD07 | CASSETTE                                                                               |
            | LD08 | COLLECTE_LIEN_PM_PRDM                                                                  |
            | LD09 | CONNECTEUR_TIROIR_ZAPM                                                                 |
            | LD10 | ENTREE_DE_CABLE_PBO                                                                    |
            | LD11 | PBO_ENVIRONNEMENT                                                                      |
            | LD12 | PM_PBO_INSTALLATION                                                                    |
            | LD13 | PTO_CARACTERISTIQUE                                                                    |
            | LD14 | PTO_INSTALLATION                                                                       |
            | LD15 | ROUTE_OPTIQUE                                                                          |
            | LD16 | TIROIR_OC                                                                              |
            | LD17 | TIROIR_ZAPM                                                                            |
            | LD18 | ADDUCTION_OC                                                                           |

        "@type":
          readOnly: false
        "@baseType":
          default: Malfacon
          const: Malfacon
        severity:
          description: |
            The severity of the malfacon

            Allowed values are:

            * `CRITICAL`

              Si la malfaçon représente un danger grave est imminent pour les personnes,
              l'OI se réserve le droit d'effectuer la reprise ou à minima sécurise les lieux
              et demande à l'OC d'intervenir.

              De son côté, l'OC se doit de signaler à l'OI toute malfaçon
              représentant un danger grave et imminent pour les personnes.

            * `MAJOR`

              La malfaçon signifie une détérioration du site technique ou un risque d'intéruption
              massive de service (dérangement collectif) ou un empêchement à produire
              de nouveaux client (depuis le passage de commande jusqu'au raccordement).

              Exemples:

              * défaut d'étanchéité sur PB
              * PM ouvert
              * site insalubre
              * brassage encombrant
              * données de localisation erronées

            * `MINOR`

              Les autres non conformités à corriger.
          enum:
            - CRITICAL
            - MAJOR
            - MINOR
        status:
          description: |
            Status de la malafacon.

            ![Malfacon status diagram](./statusOiOcImput.drawio.svg)
          enum:
            - ACKNOWLEDGED
            - CANCELLED
            - CLOSED
            - CREATING
            - IN_PROGRESS
            - PENDING
            - REJECTED
            - RESOLVED
          default: CREATING
        statusChangeReason:
          enum:
            - ACKNOWLEDGED
            - CHARGEABLE_ACCEPTED
            - CONTESTATION
            - CREATING
            - CRITICAL_IN_PROGRESS
            - DEFECT_CHARGEABLE
            - DEFECT_COMMUNICATED_BY_OC
            - DEFECT_UNCHARGEABLE
            - DELAY_ANSWER_EXPIRED
            - DELAY_RESOLUTION_OI_EXPIRED
            - DELAY_VALIDATION_EXPIRED
            - DUPLICATE
            - INFORMATION_GIVEN
            - INVALID
            - LACK_OF_INFORMATION
            - NON_CHARGEABLE_IN_PROGRESS
            - ORDER_PUT_INTO_SERVICE_FOR_MORE_THAN_A_YEAR
            - OTHER
            - PARTIALLY_RESOLVED
            - PHOTO_NOT_USABLE
            - PM_ERROR
            - REC_CANDIDATE
            - RESOLUTION_ACCEPTED
            - RESOLUTION_DATE_EXPIRED
            - RESOLUTION_REFUSED
            - RESOLVED_OC
            - RESOLVED_OI
            - UNKNOWN_RESSOURCE
            - UNRESOLVED_TICKET
            - WRONG_TICKET
          default: CREATING

    MalfaconOcBase:
      allOf:
        - $ref: "#/components/schemas/MalfaconBase"

    MalfaconOiBase:
      allOf:
        - $ref: "#/components/schemas/MalfaconBase"
      required:
        - chargeable
        - ocNumber
        - resolutionOwner
      properties:
        chargeable:
          type: boolean
        ocNumber:
          description: Nombre d'OCs concernés par la malfaçon
          type: number
        resolutionOwner:
          type: string
          readOnly: true
          enum:
            - OI
            - OC
          default: OC
        totalResolutionOcDuration:
          description: The OC resolution duration. Calculated only as long as ResolutionOwner = OC
          type: number
        expectedResolutionDate:
          descritpion: The maximum OC resolution date, recalculated only during state changes taking into account the ticket creation date and successive pauses.
          type: string
          format: date
        validationDueDate:
          description: The deadline for validation status
          type: string
          format: date
        pendingDueDate:
          description: The deadline for pending status
          type: string
          format: date

    MalfaconOiPm:
      allOf:
        - $ref: "#/components/schemas/MalfaconOiBase"
      required:
        - pm
      properties:
        "@type":
          const: malfacon.pm.oi
        localizationDetails:
          enum:
            - LD02
            - LD04
            - LD09
            - LD17
        codeFault:
          enum:
            - FD06
            - FD09
            - FD12
            - FD14
            - FD17
            - FD18
            - FD19
            - FD20
            - FD21
            - FD22
            - FD26
            - FD31
            - FD36
            - FD41
            - FD42
        pm:
          $ref: "#/components/schemas/PM"

    MalfaconOiAmontPm:
      allOf:
        - $ref: "#/components/schemas/MalfaconOiBase"
      required:
        - pm
      properties:
        "@type":
          const: malfacon.oi.amontpm
        localizationDetails:
          enum:
            - LD08
            - LD18
        codeFault:
          enum:
            - FD06
            - FD08
            - FD11
            - FD27
        pm:
          $ref: "#/components/schemas/PM"

    MalfaconOiPmPbo:
      allOf:
        - $ref: "#/components/schemas/MalfaconOiBase"
      required:
        - pm
        - pbo
      properties:
        "@type":
          const: malfacon.pmpbo.oi
        localizationDetails:
          enum:
            - LD12
        codeFault:
          enum:
            - FD01
            - FD15
        pm:
          $ref: "#/components/schemas/PM"
        pbo:
          $ref: "#/components/schemas/PBO"

    MalfaconOiPbo:
      allOf:
        - $ref: "#/components/schemas/MalfaconOiBase"
      required:
        - pbo
      properties:
        "@type":
          const: malafacon.pbo.oi
        localizationDetails:
          enum:
            - LD03
            - LD07
            - LD11
            - LD15
        codeFault:
          enum:
            - FD04
            - FD05
            - FD15
            - FD16
            - FD23
            - FD29
            - FD30
            - FD34
            - FD36
            - FD44
            - FD46
            - FD47
        pbo:
          $ref: "#/components/schemas/PBO"

    MalfaconOiCcfCable:
      allOf:
        - $ref: "#/components/schemas/MalfaconOiBase"
      required:
        - pbo
        - pto
      properties:
        "@type":
          const: malafacon.ccfcable.oi
        localizationDetails:
          enum:
            - LD05
            - LD06
            - LD10
        codeFault:
          enum:
            - FD02
            - FD03
            - FD13
            - FD37
            - FD38
        refOrder:
          description: Référence de la commande
          type: string
        localization:
          description: Localisation GPS du câble
          $ref: "#/components/schemas/Localization"
        pbo:
          $ref: "#/components/schemas/PBO"
        pto:
          $ref: "#/components/schemas/PTO"

    MalfaconOiCcfPto:
      allOf:
        - $ref: "#/components/schemas/MalfaconOiBase"
      required:
        - pto
      properties:
        "@type":
          const: malafacon.ccfpto.oi
        localizationDetails:
          enum:
            - LD13
            - LD14
        codeFault:
          enum:
            - FD10
            - FD40
            - FD43
        localization:
          description: Localisation GPS de la PTO
          $ref: "#/components/schemas/Localization"
        pto:
          $ref: "#/components/schemas/PTO"

    MalfaconOcPm:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
      required:
        - pm
      properties:
        "@type":
          const: malfacon.pm.oc
        localizationDetails:
          enum:
            - LD02
            - LD04
            - LD09
            - LD17
        codeFault:
          enum:
            - FD06
            - FD07
            - FD14
            - FD18
            - FD19
            - FD20
            - FD21
            - FD22
            - FD24
            - FD31
            - FD42
        pm:
          $ref: "#/components/schemas/PM"

    MalfaconOcAmontPm:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
      required:
        - pm
      properties:
        "@type":
          const: malafacon.amontpm.oc
        localizationDetails:
          enum:
            - LD01
            - LD08
            - LD18
        codeFault:
          enum:
            - FD06
            - FD11
            - FD27
            - FD39
            - FD48
        pm:
          $ref: "#/components/schemas/PM"

    MalfaconOcPmPbo:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
      required:
        - pm
        - pbo
      properties:
        "@type":
          const: malafacon.pmpbo.oc
        localizationDetails:
          enum:
            - LD12
        codeFault:
          enum:
            - FD01
            - FD15
        pm:
          $ref: "#/components/schemas/PM"
        pbo:
          $ref: "#/components/schemas/PBO"

    MalfaconOcPbo:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
      properties:
        "@type":
          const: malfacon.pbo.oc
        localizationDetails:
          enum:
            - LD03
            - LD07
            - LD11
        codeFault:
          enum:
            - FD04
            - FD15
            - FD16
            - FD28
            - FD29
            - FD30
            - FD34
        pbo:
          $ref: "#/components/schemas/PBO"

    MalfaconOcCcfCable:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
      required:
        - pbo
        - pto
      properties:
        "@type":
          const: malafacon.ccfcable.oc
        localizationDetails:
          enum:
            - LD05
            - LD06
            - LD10
        codeFault:
          enum:
            - FD02
            - FD03
            - FD10
            - FD13
            - FD15
            - FD25
            - FD34
            - FD35
            - FD37
            - FD38
            - FD45
            - FD49
        refOrder:
          description: Référence de la commande
          type: string
        localization:
          description: Localisation GPS du câble
          $ref: "#/components/schemas/Localization"
        pbo:
          $ref: "#/components/schemas/PBO"
        pto:
          $ref: "#/components/schemas/PTO"

    MalfaconOcCcfPto:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
      required:
        - pto
      properties:
        "@type":
          const: malfacon.ccfpto.oc
        localizationDetails:
          enum:
            - LD13
            - LD14
        codeFault:
          enum:
            - FD10
            - FD40
            - FD43
        localization:
          description: Localisation GPS de la PTO
          $ref: "#/components/schemas/Localization"
        pto:
          $ref: "#/components/schemas/PTO"

    Localization:
      $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Interop.openapi.yaml#/components/schemas/GeographicPoint

    Attachment:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Attachment.openapi.yaml#/components/schemas/Attachment
      description: |
        An attachment is a file that is attached to an entity.

        Only JPEG images are allowed.

        Extensions:

        * `.jpg`
        * `.jpeg`

        Mime types:

        * `image/jpeg`
      properties:
        mimeType:
          enum:
            - image/jpeg
        status:
          enum:
            - PENDING
            - VALIDATED
            - REJECTED
        relatedEntity:
          description: Reference to the malfacon
          minItems: 1
          maxItems: 1
          readOnly: true
          items:
            allOf:
              - $ref: "#/components/schemas/RelatedMalfacon"

    AttachmentFormData:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/tools/attachment/attachment.openapi.yaml#/components/schemas/AttachmentFormData
      properties:
        attachment:
          $ref: "#/components/schemas/Attachment"

    Note:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Note.openapi.yaml#/components/schemas/Note
      properties:
        relatedEntity:
          description: Reference to the malfacon
          minItems: 1
          maxItems: 1
          readOnly: true
          items:
            allOf:
              - $ref: "#/components/schemas/RelatedMalfacon"

    Event:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/CloudEvent.openapi.yaml#/components/schemas/CloudEvent
      required:
        - time
        - subject
      properties:
        subject:
          description: Identifiant unique de la malfaçon.
          type: string
          format: uuid
        type:
          enum:
            - fr.interop.malfacon.create
            - fr.interop.malfacon.update
            - fr.interop.malfacon.note.create
            - fr.interop.malfacon.attachment.create
            - fr.interop.malfacon.attachment.update
        datacontenttype:
          const: application/json
        data:
          oneOf:
            - $ref: "#/components/schemas/MalfaconOne"
            - $ref: "#/components/schemas/Note"
            - $ref: "#/components/schemas/Attachment"

    RelatedMalfacon:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/RelatedEntity.openapi.yaml#/components/schemas/RelatedEntity
      properties:
        "@referredType":
          const: "Malfacon"
        role:
          const: "troubleTicket"

    PM:
      $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Interop.openapi.yaml#/components/schemas/PM

    PBO:
      $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Interop.openapi.yaml#/components/schemas/PBO

    PTO:
      $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Interop.openapi.yaml#/components/schemas/PTO

  parameters:
    malfaconId:
      name: malfaconId
      in: path
      description: The malfacon id
      required: true
      schema:
        type: string

    attachmentId:
      name: attachmentId
      in: path
      description: The attachment id
      required: true
      schema:
        type: string
