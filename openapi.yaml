openapi: 3.0.3

info:
  title: Malfacon API
  version: 2.0.0
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html
  description: |
    Cet outil permet la déclaration et le traitement d'une malfaçon grâce à des flux normalisés.

    ## Dépendances

    Cette API est basé sur les APIs outils du [projet common](https://github.com/before-interop/common):

    * [TroubleTicket](https://before-interop.github.io/common/?urls.primaryName=TroubleTicket)
    * [Attachment](https://before-interop.github.io/common/?urls.primaryName=Attachment)
    * [Note](https://ggrebert.github.io/before-interop-common/?urls.primaryName=Note)
    * [Event](https://before-interop.github.io/common/?urls.primaryName=Event)

    ## Pagination

    Les listes de ressources sont paginées.

    * La valeur par défaut d'une page est `limit=50` et `offset=0`.
    * La valeur maximale de `limit` est `100`.
servers:
  - url: "{protocol}://{host}:{port}{basePath}"
    variables:
      protocol:
        enum:
          - https
          - http
        default: https
      host:
        default: localhost
      port:
        default: "8080"
      basePath:
        default: /api

tags:
  - name: TroubleTicket
    description: TroubleTicket management
  - name: Note
    description: Note management
  - name: Attachment
    description: Attachment management
  - name: Event
    description: Event management
  - name: OI
    description: OI endpoints
  - name: OC
    description: OC endpoints

paths:
  /malfacon:
    get:
      tags:
        - TroubleTicket
        - OI
      summary: Get all trouble tickets
      description: Get all trouble tickets
      operationId: getMalfacons
      parameters: &searchAndPaginateParameters
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/parameters/limit
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/parameters/offset
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/parameters/sort
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/fields.openapi.yaml#/components/parameters/fields
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The list of trouble tickets
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MalfaconBase"
        "400": &response400
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - TroubleTicket
        - OI
      summary: Count the number of trouble tickets
      description: Count the number of trouble tickets matching the given criteria.
      operationId: countMalfacons
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of trouble tickets.
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Error.openapi.yaml#/components/schemas/Error

    post:
      tags:
        - TroubleTicket
        - OI
      summary: Create a trouble ticket
      description: Create a trouble ticket
      operationId: createMalfacon
      requestBody:
        description: The malfacon to create
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MalfaconBase"
      responses:
        "201": &troubleTicket201
          description: The created malfacon
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MalfaconBase"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/headers/ETag
        "400": *response400
        "403": &response403
          description: |
            **Forbidden**

            Le serveur a compris la requête, mais refuse de l'exécuter car le client n'a pas respecté le processus de création ou de mise à jour.

            Exemple: passage du status `ACKNOWLEDGED` à `RESOLVED` sans passer par le status `IN_PROGRESS`.

            * Le champ `reason` de la réponse d'erreur doit contenir la liste des tickets en conflit séparés par des virgules.
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Error.openapi.yaml#/components/schemas/Error

  /malfacon/{malfaconId}:
    parameters:
      - $ref: "#/components/parameters/malfaconId"

    get:
      tags:
        - TroubleTicket
        - OI
      summary: Get a trouble ticket
      description: Get a trouble ticket
      operationId: getMalfacon
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/fields.openapi.yaml#/components/parameters/fields
      responses:
        "200":
          description: The malfacon
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MalfaconBase"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/headers/ETag
        "404": &response404
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Error.openapi.yaml#/components/schemas/Error

    put:
      tags:
        - TroubleTicket
        - OI
      summary: Update a trouble ticket
      description: Update a trouble ticket
      operationId: updateMalfacon
      requestBody:
        description: The trouble ticket to update
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MalfaconBase"
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/parameters/If-Match
      responses:
        "200": *troubleTicket201
        "400": *response400
        "403": *response403
        "404": *response404
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-412
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    patch:
      tags:
        - TroubleTicket
        - OI
      summary: Partially update a trouble ticket
      description: Partially update a trouble ticket
      operationId: patchMalfacon
      requestBody:
        description: The data to update
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MalfaconBase"
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/parameters/If-Match
      responses:
        "200": *troubleTicket201
        "400": *response400
        "403": *response403
        "404": *response404
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-412
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

  /malfacon/{malfaconId}/note:
    parameters:
      - $ref: "#/components/parameters/malfaconId"

    get:
      tags:
        - Note
        - OI
      summary: Get all notes of a trouble ticket
      description: Get all notes of a trouble ticket
      operationId: getMalfaconNotes
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of notes
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Note"
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Note
        - OI
      summary: Count the number of notes of a trouble ticket
      description: Count the number of notes of a trouble ticket matching the given criteria.
      operationId: countMalfaconNotes
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of notes
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Note
        - OI
      summary: Create a note for a trouble ticket
      description: Create a note for a trouble ticket
      operationId: createMalfaconNote
      requestBody:
        description: The note to create
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Note"
      responses:
        "201":
          description: The created note
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Note"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/headers/ETag
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

  /malfacon/{malfaconId}/attachment:
    parameters:
      - $ref: "#/components/parameters/malfaconId"

    get:
      tags:
        - Attachment
        - OI
      summary: List attachments
      description: Get all attachments of a trouble ticket
      operationId: getMalfaconAttachments
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of attachments
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Attachment"
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Attachment
        - OI
      summary: Get the number of attachments
      description: This method returns the number of attachments matching the criteria.
      operationId: countMalfaconAttachments
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of attachments
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Attachment
        - OI
      summary: Create a attachment
      description: This method allows to create a attachment.
      operationId: createMalfaconAttachment
      requestBody:
        description: The attachment to create
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/AttachmentFormData"
      responses:
        "201":
          description: The created attachment
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Attachment"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/headers/ETag
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

  /malfacon/{malfaconId}/attachment/{attachmentId}/content:
    parameters:
      - $ref: "#/components/parameters/malfaconId"
      - $ref: "#/components/parameters/attachmentId"

    get:
      tags:
        - Attachment
        - OI
      summary: Download the content of an attachment
      description: This method allows to download the content of an attachment.
      operationId: downloadMalfaconAttachment
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Match
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/If-None-Match
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Modified-Since
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Unmodified-Since
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/Range
      responses:
        "200":
          description: The content of the attachment
          content:
            application/octet-stream: {}
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-412

  /malfacon/event:
    get:
      tags:
        - Event
        - OI
      summary: Get all events of all trouble tickets
      description: Get all events of all trouble tickets
      operationId: getMalfaconEvents
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of events
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Event"
        "400": *response400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Event
        - OI
      summary: Count the number of events of all trouble tickets
      description: Count the number of events of all trouble tickets matching the given criteria.
      operationId: countMalfaconEvents
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of events
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Event
        - OC
      summary: Receive an event for a trouble ticket
      description: Receive an event for a trouble ticket
      operationId: receiveMalfaconEvent
      requestBody:
        description: The event to receive
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Event"
      responses:
        "200":
          description: The event has been received
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        "204":
          description: The event has been received

        default:
          description: |
            L'événement a été reçu avec succès.

            La réponse n'a pas l'obligation de contenir un body.
            Si l'OC retourne un body, celui-ci pourra être enregistré dans le journal de l'OI.
        "400": *response400
        "403": *response403
        "404": *response404
        "500":
          description: |
            **Internal Server Error**

            Cette erreur se produit lorsque le serveur a rencontré une condition inattendue qui l'a empêché de répondre à la demande.

            * Le champ reason de la réponse d'erreur peut contenir des informations sur l'erreur.
          content:
            application/json:
              schema:
                $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-500
        "501":
          description: |
            **Not Implemented**

            Cette erreur se produit lorsque le serveur ne prend pas en charge la fonctionnalité nécessaire pour répondre à la demande

            * Le champ reason de la réponse d'erreur peut contenir des informations sur l'erreur.

components:
  schemas:
    MalfaconBase:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/TroubleTicket.openapi.yaml#/components/schemas/TroubleTicket
        - discriminator:
            propertyName: "@type"
            mapping:
              "malfacon.pm.oi": "#/components/schemas/MalfaconOiPm"
              "malfacon.oi.amontpm": "#/components/schemas/MalfaconOiAmontPm"
              "malfacon.pbo.oi": "#/components/schemas/MalfaconOiPbo"
              "malfacon.ccf.oi": "#/components/schemas/MalfaconOiCcf"
              "malfacon.pm.oc": "#/components/schemas/MalfaconOcPm"
              "malfacon.amontpm.oc": "#/components/schemas/MalfaconOcAmontPm"
              "malfacon.pmpbo.oc": "#/components/schemas/MalfaconOcPmPbo"
              "malfacon.pbo.oc": "#/components/schemas/MalfaconOcPbo"
              "malfacon.ccf.oc": "#/components/schemas/MalfaconOcCcf"
          type: object
          required:
            - code_oi
            - code_oc
            - "@type"
            - severity
            - quantity
          properties:
            code_oi: #Code ARCEP de l'OI.
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/CodeOperateurArcep
            code_oc: #Code ARCEP de l'OC.
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/CodeOperateurArcep
            externalId:
              description: Référence du ticket créé dans le système de l'OC
              type: string
            quantity:
              description: |
                The volumetry of the malfacon.
              type: integer
              example: 1
            recoveryQuantity:
              description: |
                Ce champs indique la quantité de malfaçon reprise.
                C'est un entier qui doit être renseignée au moment du passage en Resolved, par l'OC ou par l'OI suivant le cas de gestion,
                et donc la valeur doit être >= au champs quantity renseigné à l'initialisation du ticket.
              type: integer

            "@type":
              type: string
              readOnly: false
            "@baseType":
              default: "Malfacon"
              type: string
            severity:
              description: |
                The severity of the malfacon

                Allowed values are:

                * `CRITICAL`

                  Si la malfaçon représente un danger grave est imminent pour les personnes,
                  l'OI se réserve le droit d'effectuer la reprise ou à minima sécurise les lieux
                  et demande à l'OC d'intervenir.

                  De son côté, l'OC se doit de signaler à l'OI toute malfaçon
                  représentant un danger grave et imminent pour les personnes.

                * `MAJOR`

                  La malfaçon signifie une détérioration du site technique ou un risque d'intéruption
                  massive de service (dérangement collectif) ou un empêchement à produire
                  de nouveaux client (depuis le passage de commande jusqu'au raccordement).

                  Exemples:

                  * défaut d'étanchéité sur PB
                  * PM ouvert
                  * site insalubre
                  * brassage encombrant
                  * données de localisation erronées

                * `MINOR`

                  Les autres non conformités à corriger.
              enum:
                - CRITICAL
                - MAJOR
                - MINOR
            status:
              description: |
                Status de la malfacon.

                ![Malfacon status diagram](./statusOiOcImput.drawio.svg)
              enum:
                - ACKNOWLEDGED
                - CANCELED
                - CLOSED
                - CREATING
                - IN_PROGRESS
                - PENDING
                - REJECTED
                - RESOLVED
              default: CREATING

    MalfaconOcBase:
      allOf:
        - $ref: "#/components/schemas/MalfaconBase"
      required:
        - statusChangeReason
      properties:
        statusChangeReason:
          enum:
            - ACKNOWLEDGED
            - CLOSED
            - CREATING
          default: CREATING

    MalfaconOiBase:
      allOf:
        - $ref: "#/components/schemas/MalfaconBase"
      required:
        - attributable
        - ocNumber
        - resolutionOwner
        - statusChangeReason
      properties:
        attributable:
          type: boolean
        ocNumber:
          description: |
            Nombre d'OCs concernés par la malfaçon.
            OcNumber doit être supérieur ou égal à 1 et obligatoire
          type: integer
          readOnly: true
          minimum: 1
        activationRate:
          description: Le taux d'activation est un pourcentage représentant la part de lignes activées par l'OC sur l'élément de réseau (PM ou PBO).
          type: number
          minimum: 0
          exclusiveMinimum: true
          maximum: 100
          readOnly: true
        resolutionOwner:
          type: string
          readOnly: true
          enum:
            - OI
            - OC
          default: OC
        statusChangeReason:
          enum:
            - ACKNOWLEDGED
            - ATTRIBUTABLE_ACCEPTED
            - CANCELED
            - CONTESTATION_ACCEPTED
            - CONTESTATION_DUPLICATE
            - CONTESTATION_EQUIPMENT_ERROR
            - CONTESTATION_NOT_ALLOWED
            - CONTESTATION_OC_ERROR
            - CONTESTATION_OI_RESPONSABILITY
            - CONTESTATION_ORDER_PUT_INTO_SERVICE_FOR_MORE_THAN_A_YEAR
            - CONTESTATION_PHOTO_NOT_USABLE
            - CONTESTATION_REFUSED
            - CREATING
            - CRITICAL
            - INFORMATION_GIVEN
            - INFORMATION_REQUEST
            - INVALID_FORMAT
            - NON_ATTRIBUTABLE
            - OC_RESOLUTION_DELAY_EXPIRED
            - OI_RESOLUTION_IMPOSSIBLE
            - OI_RESOLUTION_RENUNCIATION
            - OI_RESPONSE_DELAY_EXPIRED
            - OI_VALIDATION_DELAY_EXPIRED
            - RESOLUTION_REFUSED_EQUIPMENT_ERROR
            - RESOLUTION_REFUSED_NOT_REPAIRED
            - RESOLUTION_REFUSED_PARTIALLY_RESOLVED
            - RESOLUTION_REFUSED_PHOTO_NOT_USABLE
            - RESOLVED_OC
            - RESOLVED_OC_VALIDATED
            - RESOLVED_OI_ATTRIBUTABLE
            - RESOLVED_OI_CRITICAL
            - RESOLVED_OI_NON_ATTRIBUTABLE
            - RESOLVED_OI_VALIDATED
          default: CREATING
        maxResolutionOcDuration:
          type: object
          $ref: "#/components/schemas/MaxResolutionOcDuration"

        totalResolutionOcDuration:
          description: The OC resolution duration in seconds. Calculated only as long as ResolutionOwner = OC
          type: number
        expectedResolutionDate:
          description: The maximum OC resolution date, recalculated only during state changes taking into account the ticket creation date and successive pauses.
          type: string
          format: date
        validationDueDate:
          description: The deadline for validation status
          type: string
          format: date
        pendingDueDate:
          description: The deadline for pending status
          type: string
          format: date

    MaxResolutionOcDuration:
      type: object
      properties:
        value:
          type: integer
          description: Duration in seconds
          readOnly: true
        reason:
          type: string
          readOnly: true

    MalfaconOiPm:
      allOf:
        - $ref: "#/components/schemas/MalfaconOiBase"
      required:
        - pm
        - codeFault
        - localizationDetails
      properties:
        localization:
          type: string
          default: "PM"
        localizationDetails:
          type: string
          enum:
            - LD02
            - LD04
            - LD09
            - LD15
            - LD16
            - LD17
        codeFault:
          type: string
          enum:
            - FD06
            - FD10
            - FD13
            - FD14
            - FD17
            - FD18
            - FD19
            - FD20
            - FD21
            - FD22
            - FD26
            - FD31
            - FD32
            - FD36
            - FD41
            - FD50
        pm:
          $ref: "#/components/schemas/PM"
        opticalRoute:
          type: array
          items:
            $ref: "#/components/schemas/MalfaconOpticalRoutePM"
    MalfaconOiAmontPm:
      allOf:
        - $ref: "#/components/schemas/MalfaconOiBase"
      required:
        - pm
        - codeFault
        - localizationDetails
      properties:
        localization:
          type: string
          default: "AMONT_PM"
        localizationDetails:
          type: string
          enum:
            - LD08
            - LD18
        codeFault:
          type: string
          enum:
            - FD06
            - FD08
            - FD11
            - FD27
        pm:
          $ref: "#/components/schemas/PM"

    MalfaconOiPbo:
      allOf:
        - $ref: "#/components/schemas/MalfaconOiBase"
      required:
        - pbo
        - codeFault
        - localizationDetails
      properties:
        localization:
          type: string
          default: "PBO"
        localizationDetails:
          type: string
          enum:
            - LD03
            - LD07
            - LD11
            - LD15
        codeFault:
          type: string
          enum:
            - FD05
            - FD15
            - FD16
            - FD23
            - FD29
            - FD30
            - FD34
            - FD36
            - FD44
            - FD46
            - FD47
        pbo:
          $ref: "#/components/schemas/PBO"
        pm:
          $ref: "#/components/schemas/PM"
        opticalRoute:
          type: array
          items:
            $ref: "#/components/schemas/MalfaconOpticalRoutePBO"
    MalfaconOiCcf:
      allOf:
        - $ref: "#/components/schemas/MalfaconOiBase"
      required:
        - codeFault
        - localizationDetails
      properties:
        localization:
          type: string
          default: "CCF"
        localizationDetails:
          type: string
          enum:
            - LD05
            - LD06
            - LD10
            - LD13
            - LD14
        codeFault:
          type: string
          enum:
            - FD02
            - FD09
            - FD12
            - FD15
            - FD25
            - FD33
            - FD34
            - FD40
            - FD43
            - FD45
            - FD49
            - FD51
        refOrder:
          description: Référence de la commande
          type: string
        geographicLocation: # Localisation GPS du câble
          $ref: "#/components/schemas/GeographicLocation"
        pbo:
          $ref: "#/components/schemas/PBO"
        pto:
          $ref: "#/components/schemas/PTO"

    MalfaconOcPm:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
      required:
        - pm
        - codeFault
        - localizationDetails
      properties:
        localization:
          type: string
          default: "PM"
        localizationDetails:
          type: string
          enum:
            - LD02
            - LD04
            - LD09
            - LD17
        codeFault:
          type: string
          enum:
            - FD06
            - FD07
            - FD18
            - FD19
            - FD20
            - FD21
            - FD22
            - FD24
            - FD32
            - FD42
            - FD50
        pm:
          $ref: "#/components/schemas/PM"

    MalfaconOcAmontPm:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
      required:
        - pm
        - codeFault
        - localizationDetails
      properties:
        localization:
          type: string
          default: "AMONT_PM"
        localizationDetails:
          type: string
          enum:
            - LD01
            - LD08
            - LD18
        codeFault:
          type: string
          enum:
            - FD06
            - FD11
            - FD27
            - FD39
            - FD48
        pm:
          $ref: "#/components/schemas/PM"

    MalfaconOcPmPbo:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
      required:
        - pm
        - pbo
        - codeFault
        - localizationDetails
      properties:
        localization:
          type: string
          default: "PM_PBO"
        localizationDetails:
          type: string
          enum:
            - LD12
        codeFault:
          type: string
          enum:
            - FD01
            - FD15
        pm:
          $ref: "#/components/schemas/PM"
        pbo:
          $ref: "#/components/schemas/PBO"

    MalfaconOcPbo:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
      required:
        - codeFault
        - localizationDetails
      properties:
        localization:
          type: string
          default: "PBO"
        localizationDetails:
          type: string
          enum:
            - LD03
            - LD07
            - LD11
        codeFault:
          type: string
          enum:
            - FD04
            - FD15
            - FD16
            - FD28
            - FD29
            - FD30
        pbo:
          $ref: "#/components/schemas/PBO"

    MalfaconOcCcf:
      allOf:
        - $ref: "#/components/schemas/MalfaconOcBase"
      required:
        - pbo
        - pto
        - codeFault
        - localizationDetails
      properties:
        localization:
          type: string
          default: "CCF"
        localizationDetails:
          type: string
          enum:
            - LD06
        codeFault:
          type: string
          enum:
            - FD02
            - FD03
            - FD12
            - FD37
            - FD38
        refOrder:
          description: Référence de la commande
          type: string
        geographicLocation: # Localisation GPS du câble
          $ref: "#/components/schemas/GeographicLocation"
        pbo:
          $ref: "#/components/schemas/PBO"
        pto:
          $ref: "#/components/schemas/PTO"

    GeographicLocation:
      $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/GeographicPoint

    Note:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Note.openapi.yaml#/components/schemas/Note
      properties:
        relatedEntity:
          description: |
            Relation entre la note et la malfaçon.
            Ce champ est renseigné par l'OI lors de la création de la note.
          type: array
          minItems: 1
          maxItems: 1
          readOnly: true
          items:
            allOf:
              - $ref: "#/components/schemas/RelatedMalfacon"

    Attachment:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Attachment.openapi.yaml#/components/schemas/Attachment
      description: |
        An attachment is a file that is attached to an entity.

        Only JPEG images are allowed.

        Extensions:

        * `.csv`
        * `.docx`
        * `.jpeg`
        * `.jpg`
        * `.ods`
        * `.odt`
        * `.pdf`
        * `.png`
        * `.svg`
        * `.xlsx`

        Mime types:

        * `application/pdf`
        * `application/vnd.oasis.opendocument.spreadsheet`
        * `application/vnd.oasis.opendocument.text`
        * `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`
        * `application/vnd.openxmlformats-officedocument.wordprocessingml.document`
        * `image/jpeg`
        * `image/jpg`
        * `image/png`
        * `image/svg+xml`
        * `test/csv`
      properties:
        proofType:
          enum:
            - ISSUE
            - RESOLUTION
          default: ISSUE
        primary:
          type: boolean
          description: Specify if this is the main attachment. There can only be one primary attachment for each type.
          default: true
        mimeType:
          enum:
            - application/pdf
            - application/vnd.oasis.opendocument.spreadsheet
            - application/vnd.oasis.opendocument.text
            - application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
            - application/vnd.openxmlformats-officedocument.wordprocessingml.document
            - image/jpeg
            - image/jpg
            - image/png
            - image/svg+xml
            - test/csv
        status:
          enum:
            - PENDING
            - VALIDATED
            - REJECTED
        relatedEntity:
          description: Reference to the malfacon
          minItems: 1
          maxItems: 1
          readOnly: true
          items:
            allOf:
              - $ref: "#/components/schemas/RelatedMalfacon"

    AttachmentFormData:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/schemas/AttachmentFormData
      properties:
        attachment:
          $ref: "#/components/schemas/Attachment"

    Event:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/CloudEvent.openapi.yaml#/components/schemas/CloudEvent
        - required:
            - time
            - subject
            - type
          discriminator:
            propertyName: type
            mapping:
              "fr.interop.malfacon.create": "#/components/schemas/EventMalfacon"
              "fr.interop.malfacon.update": "#/components/schemas/EventMalfacon"
              "fr.interop.malfacon.note.create": "#/components/schemas/EventMalfaconNote"
              "fr.interop.malfacon.attachment.create": "#/components/schemas/EventMalfaconAttachment"
              "fr.interop.malfacon.attachment.update": "#/components/schemas/EventMalfaconAttachment"
          properties:
            subject:
              description: Identifiant unique de la malfaçon.
              type: string
              format: uuid
            type:
              type: string
            datacontenttype:
              type: string
              default: "application/json"

    EventMalfacon:
      allOf:
        - $ref: "#/components/schemas/Event"
        - properties:
            data:
              $ref: "#/components/schemas/MalfaconBase"

    EventMalfaconNote:
      allOf:
        - $ref: "#/components/schemas/Event"
        - properties:
            data:
              $ref: "#/components/schemas/Note"

    EventMalfaconAttachment:
      allOf:
        - $ref: "#/components/schemas/Event"
        - properties:
            data:
              $ref: "#/components/schemas/Attachment"

    RelatedMalfacon:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/RelatedEntity.openapi.yaml#/components/schemas/RelatedEntity
      properties:
        "@referredType":
          type: string
          default: "Malfacon"
        role:
          type: string
          default: "troubleTicket"

    PM:
      $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/PM

    PBO:
      $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/PBO

    PTO:
      $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/PTO

    MalfaconOpticalRoutePlanned:
      required:
        - name
        - position
        - noteTube
        - noteFiber
      allOf:
        - $ref: "#/components/schemas/OpticalRoute"
        - properties:
            "@type":
              example: MalfaconOpticalRoutePlanned
            referencePTO:
              description: Référence du PTO
              type: string
            referenceVIA:
              description: Référence du VIA
              type: string

    MalfaconOpticalRouteObservedPBO:
      required:
        - noteTube
        - noteFiber
      allOf:
        - $ref: "#/components/schemas/OpticalRoute"
        - properties:
            "@type":
              example: MalfaconOpticalRouteObserved

    MalfaconOpticalRouteObservedPM:
      required:
        - name
        - position
      allOf:
        - $ref: "#/components/schemas/OpticalRoute"
        - properties:
            "@type":
              example: MalfaconOpticalRouteObservedPM
            referenceONT:
              description: n° de série ou adresse Mac de l’ONT
              type: string

    MalfaconOpticalRouteFinal:
      required:
        - name
        - position
        - noteTube
        - noteFiber
      description: |
        n’est pas obligatoire pour l’OI mais doit être renseignée par l’OC quand il corrige
      allOf:
        - $ref: "#/components/schemas/OpticalRoute"
        - properties:
            "@type":
              example: MalfaconOpticalRouteFinal
            dechargeNumber:
              description: n° de décharge issue de la demande de mutation
              type: string
            note:
              description: explication des corrections apportées, ou blocage rencontré, par l’OC
              type: string

    MalfaconOpticalRoutePM:
      description: Pour les routes optiques obligatoire, il faut mettre la valeur "UNKNOWN" pour les champs inconnus qui sont obligatoires.
      required:
        - observed
        - planned
      properties:
        planned:
          $ref: "#/components/schemas/MalfaconOpticalRoutePlanned"
        observed:
          $ref: "#/components/schemas/MalfaconOpticalRouteObservedPM"
        final:
          $ref: "#/components/schemas/MalfaconOpticalRouteFinal"

    MalfaconOpticalRoutePBO:
      description: Pour les routes optiques obligatoire, il faut mettre la valeur "UNKNOWN" pour les champs inconnus qui sont obligatoires.
      required:
        - observed
        - planned
      properties:
        planned:
          $ref: "#/components/schemas/MalfaconOpticalRoutePlanned"
        observed:
          $ref: "#/components/schemas/MalfaconOpticalRouteObservedPBO"
        final:
          $ref: "#/components/schemas/MalfaconOpticalRouteFinal"

    OpticalRoute:
      properties:
        "@baseType":
          example: OpticalRoute
        "@type":
          example: OpticalRoute
        name:
          description: Nom du module PM
          type: string
        noteFiber:
          description: ajout d'information concernant la fibre
          type: string
        noteTube:
          description: ajout d'information concernant le tube
          type: string
        position:
          description: Position du module PM
          type: string

  parameters:
    malfaconId:
      name: malfaconId
      in: path
      description: The malfacon id
      required: true
      schema:
        type: string

    attachmentId:
      name: attachmentId
      in: path
      description: The attachment id
      required: true
      schema:
        type: string
